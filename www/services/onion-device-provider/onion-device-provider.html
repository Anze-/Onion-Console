<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="onion-device-provider">
	<script>
		'use strict';

		(function () {
			var macResult = null;
			var ipResult = null;
			var rxtxResult = null;

			var ready = function (){
				onionConsole.getService('onion-ubus-provider', (function (ubus) {
					this.ubus = ubus;
				}).bind(this));			
			};

			var getDeviceType = function(callback){
				var params = {};
				callback = callback || this.noop;
				this.ubus.request('system', 'board', params, function(result){
					callback(result[1].model);
				});
			};

			var getMAC = function (callback) {
				var params = {
					device: 'wlan0'
				};
				macResult = callback || this.noop;
				this.ubus.request('iwinfo', 'assoclist', params, setMACResult);
			};

			var getNetMask = function(callback){
				this.getDeviceType((function(device){
					if(device === 'Onion Omega'){
						var params = {
							config: 'network',
							section: 'wlan',
							option: 'netmask'
						};
						console.log("inside getNEt Masl");
						callback = callback || this.noop;
						this.ubus.request('uci','get', params, function(result){
							console.log(result);
							var response = result[1].value;
							callback(response);
						});
					}else{
						var params = {
							config: 'network',
							section: 'lan',
							option: 'netmask'
						};
						console.log("inside getNEt Masl");
						callback = callback || this.noop;
						this.ubus.request('uci','get', params, function(result){
							console.log(result);
							var response = result[1].value;
							callback(response);
						});
					}
				}).bind(this));
			};

			var setMACResult = function (result) {
				var returnCode = result[0];
				if (returnCode === 0) { 
				    if (result[1] !== null && result[1].results[0] !== null && result[1].results[0].mac !== null) {
				        var mac = result[1].results[0].mac;

						macResult({
							mac: mac
						});
				    } else {
					    macResult({
					    	mac: ''
					    });    
					}
				} else {
				    console.log('Failed to get MAC address!')
					macResult({
						mac: ''
					});
				}
			};

			var getSystem = function (callback) {
				this.ubus.request('system', 'info', {}, callback);
			};

			var getRxTx = function (callback) {
				var params =  {};
				callback = callback || this.noop;
				this.ubus.request('network.device','status', params, (function(result){
					this.setRxTxResult(result,callback);
				}).bind(this));
			};

			var setRxTxResult = function (result,callback) {
				var returnCode = result[0];
				var receivedkB = 0;
				var transmittedkB = 0;
				if(returnCode===0){
					this.getDeviceType((function(type){
						var returnCode = result[0];
						var receivedkB = 0;
						var transmittedkB = 0;
						if(type == 'Onion Omega'){
							var rx = result[1].wlan0.statistics.rx_bytes;
							receivedkB = parseInt(rx);
                    		if (receivedkB > 0) {
                        		receivedkB = (receivedkB / 1000).toFixed(0);
                        	}
                        	var tx = result[1].wlan0.statistics.tx_bytes;
                    		transmittedkB = parseInt(tx);
		                    if (transmittedkB > 0) {
		                        transmittedkB = (transmittedkB / 1000).toFixed(0);
		                    }
		                    callback([{received:receivedkB},{transmitted:transmittedkB}]);
                    	}else{
							var rx = result[1].apcli0.statistics.rx_bytes;
							receivedkB = parseInt(rx);
                    		if (receivedkB > 0) {
                        		receivedkB = (receivedkB / 1000).toFixed(0);
                        	}
                        	var tx = result[1].apcli0.statistics.tx_bytes;
                    		transmittedkB = parseInt(tx);
		                    if (transmittedkB > 0) {
		                        transmittedkB = (transmittedkB / 1000).toFixed(0);
		                    }
		                    callback([{received:receivedkB},{transmitted:transmittedkB}]);
						}
					}).bind(this));
				} else {
				    console.log('Failed to get received bytes and transmitted bytes!');
                    callback([{received: ''}, {transmitted: ''}]);
				}
			};
			
			var getIP = function (callback) {
				var params =  {
				    command: 'ifconfig'
				};
				ipResult = callback || this.noop;
				this.ubus.request('file', 'exec', params, setIPResult);
			};

			var getIPAddr = function(callback){
				console.log("inside get IPAddr");
				var params = {};
				callback = callback || this.noop;
				this.ubus.request('network.interface.wwan', 'status', params, function(result){
					console.log(result);
					console.log(result[1]['ipv4-address'][0]['address']);
					var response = result[1]['ipv4-address'][0]['address'];
					callback(response);
				}.bind(this));
			};

			var setIPAddrResult = function(result){
				console.log(result);
				// if(result[0]===0){
				// 	console.log(result[1].ipv4-address[0].address);
				// 	ip = 
				// }
				var returnCode = result[0];
			    var available = false;
			    var ip = '-';
			    var netmask = '-';
			};

			var isOnline = function(callback){
				this.getDeviceType(function(result){
					var available = false;
					if(result == 'Onion Omega'){
						this.ubus.request('network.device','status',{name:"wlan0"},function(result){
							if(result[0]===0){
								available = true;
								callback(available);
							}else{
								callback(available);
							}
						});
					}else{
						this.ubus.request('network.device','status',{name:"apcli0"},function(result){
							console.log(result);
							if(result[0]===0){
								available = true;
								callback(available);
							}else{
								callback(available);
							}
						});
					}
				}.bind(this));
			};

			var getMACAddr = function(callback){
				this.getDeviceType(function(result){
					var addr = '';
					if(result == 'Onion Omega'){
						this.ubus.request('network.device','status',{name:"wlan0"},function(result){
							if(result[0]===0){
								addr = result[1].macaddr;
								callback(addr);
							}else{
								callback(addr);
							}
						});
					}else{
						this.ubus.request('network.device','status',{name:"apcli0"},function(result){
							console.log(result);
							if(result[0]===0){
								addr = result[1].macaddr;
								callback(addr);
							}else{
								callback(addr);
							}
						});
					}
				}.bind(this));
			}
			
			var setIPResult = function (result) {
			    var returnCode = result[0];
			    var available = false;
			    var ip = '-';
			    var netmask = '-';
                console.log(result);
                if (result[0] === 0 && result[1].code === 0) { 
					var wlanIndex = result[1].stdout.indexOf('wlan0');
					if (wlanIndex > 0) {
					    available = true;
					    var startIndex = result[1].stdout.indexOf('inet addr:', wlanIndex);
					    var endIndex = result[1].stdout.indexOf('  Bcast', startIndex);
					    ip = result[1].stdout.substring(startIndex + 'inet addr:'.length, endIndex);
					    startIndex = result[1].stdout.lastIndexOf('Mask:');
					    endIndex = result[1].stdout.indexOf('\n', startIndex);
					    netmask = result[1].stdout.substring(startIndex + 'Mask:'.length, endIndex);
					} else {
					    console.log('Failed to retrieve IP address information!');
					}
			    } else {
					console.log('Failed to execute IP address command!');
			    }
			    
			    ipResult([{available: available}, {ip: ip}, {netmask: netmask}]);
			};

			var changePassword = function (passwordCurrent, passwordNew, passwordNewVerify) {
				var promise = new Promise(function (resolve, reject) {
					if (passwordNew === passwordNewVerify) {
						onionConsole.getService('onion-session-provider', function (session) {
							session.checkLogin(passwordCurrent)
							.then(function () {
								onionConsole.getService('onion-ubus-provider', function (ubus) {
									ubus.request('file', 'exec', {
										command: 'change-password',
										params: [
											'-user', 'root',
											'-password', passwordNew,
											'-verify', passwordNew
										]
									}, function (data) {
										if (data.length === 2 && data[0] === 0) {
											resolve('You have successfully changed your password!');
										} else {
											reject(Error('Failed to change your password.'));
										}
									});
					            });
							}, function (err) {
								reject(Error('Current password is invalid.'));
							})
						});
					} else {
						reject(Error("New passwords don't match."));
					}
				});

				return promise;
			};

			var changeHostname = function (hostnameNew) {
				var promise = new Promise(function (resolve, reject) {
					if (hostname !== '') {
						onionConsole.getService('onion-ubus-provider', function (ubus) {
							ubus.request('uci', 'set', {
								config: 'system',
								section: '@system[0]',
								values: {
									hostname: hostnameNew
								}
							}, function (result) {
								if (result[0] === 0) {
									ubus.request('uci', 'commit', {
										config: 'system'
									}, function (result) {
										if (result[0] === 0) {
											resolve('Hostname changed successfully.');
										}
									});
								} else {
									reject(Error('Unable to set the hostname.'));
								}
							});
						});
					} else {
						reject(Error('Hostname cannot be empty.'));
					}
				});

				return promise;
			};

			var changeTimezone = function (timezoneNew, zonenameNew) {
				var promise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-ubus-provider', function (ubus) {
						ubus.request('uci', 'set', {
							config: 'system',
							section: '@system[0]',
							values: {
								timezone: timezoneNew,
								zonename: zonenameNew
							}
						}, function (result) {
							if (result[0] === 0) {
								ubus.request('uci', 'commit', {
									config: 'system'
								}, function (result) {
									if (result[0] === 0) {
										resolve('Timezone changed successfully.');
									} else {
										reject(Error('Unable to set the timezone with UBUS'));
									}
								});
							} else {
								reject(Error('Unable to set the timezone.'));
							}
						});
					});
				});

				return promise;
			};
			
			var shutdown = function () {
				var shutdownPromise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-ubus-provider', function (ubus) {
						ubus.request('file', 'exec', {
							command: 'power-down', 
							params: [
								'-f'
							]
						}, function (result) {
							console.log(result);
							if (result[0] === 0) {
								resolve();
							} else {
								reject();
							}
						});
					});
				});

				return shutdownPromise;
			};

			var reboot = function () {
				var rebootPromise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-ubus-provider', function (ubus) {
						ubus.request('file', 'exec', {
							command: 'reboot', 
							params: [
								'-d', 
								'5',
								'&'
							]
						}, function (result) {
							console.log(result);
							if (result[0] === 0) {
								resolve();
							} else {
								reject();
							}
						});
					});
				});

				return rebootPromise;
			};

			Polymer({
				is: 'onion-device-provider',
				ready: ready,
				//update: update,
				noop: function () {},
				ready: ready,
				getMAC: getMAC,
				getSystem: getSystem,
				setMACResult: setMACResult,
				getRxTx: getRxTx,
				getNetMask: getNetMask,
				setRxTxResult: setRxTxResult,
				getIP: getIP,
				setIPResult: setIPResult,
				getIPAddr: getIPAddr,
				setIPAddrResult: setIPAddrResult,
				changePassword: changePassword,
				changeHostname: changeHostname,
				changeTimezone: changeTimezone,
				shutdown: shutdown,
				reboot: reboot,
				getDeviceType: getDeviceType,
				isOnline: isOnline,
				getMACAddr: getMACAddr
			});
        })();
	</script>
</dom-module>
