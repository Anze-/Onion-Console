<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="onion-device-provider">
	<script>
		'use strict';

		(function () {
			var macResult = null;
			var ipResult = null;
			var rxtxResult = null;

			var ready = function (){
				onionConsole.getService('onion-ubus-provider', (function (ubus) {
					this.ubus = ubus;
				}).bind(this));			
			};

			var getMAC = function (callback) {
				var params = {
					device: 'wlan0'
				};
				macResult = callback || this.noop;
				this.ubus.request('iwinfo', 'assoclist', params, setMACResult);
			};

			var setMACResult = function (result) {
				var returnCode = result[0];
				if (returnCode === 0) { 
				    if (result[1] !== null && result[1].results[0] !== null && result[1].results[0].mac !== null) {
				        var mac = result[1].results[0].mac;

						macResult({
							mac: mac
						});
				    } else {
					    macResult({
					    	mac: ''
					    });    
					}
				} else {
				    console.log('Failed to get MAC address!')
					macResult({
						mac: ''
					});
				}
			};

			var getSystem = function (callback) {
				this.ubus.request('system', 'info', {}, callback);
			};

			var getRxTx = function (callback) {
				var params =  {};
				rxtxResult = callback || this.noop;
				this.ubus.request('network.device', 'status', params, setRxTxResult);
			};

			var setRxTxResult = function (result) {
				var returnCode = result[0];
				var receivedkB = 0;
				var transmittedkB = 0;
				
				if (returnCode === 0) {  
				    var rx = result[1].wlan0.statistics.rx_bytes;

                    receivedkB = parseInt(rx);
                    if (receivedkB > 0) {
                        receivedkB = (receivedkB / 1000).toFixed(0);
                    }
                    var tx = result[1].wlan0.statistics.tx_bytes;
                    transmittedkB = parseInt(tx);
                    if (transmittedkB > 0) {
                        transmittedkB = (transmittedkB / 1000).toFixed(0);
                    }

	                rxtxResult([{received: receivedkB}, {transmitted: transmittedkB}]);
				} else {
				    console.log('Failed to get received bytes and transmitted bytes!');
                    rxtxResult([{received: ''}, {transmitted: ''}]);
				}
			};
			
			var getIP = function (callback) {
				var params =  {
				    command: 'ifconfig'
				};
				ipResult = callback || this.noop;
				this.ubus.request('file', 'exec', params, setIPResult);
			};
			
			var setIPResult = function (result) {
			    var returnCode = result[0];
			    var available = false;
			    var ip = '-';
			    var netmask = '-';
                
                if (result[0] === 0 && result[1].code === 0) { 
					var wlanIndex = result[1].stdout.indexOf('wlan0');
					if (wlanIndex > 0) {
					    available = true;
					    var startIndex = result[1].stdout.indexOf('inet addr:', wlanIndex);
					    var endIndex = result[1].stdout.indexOf('  Bcast', startIndex);
					    ip = result[1].stdout.substring(startIndex + 'inet addr:'.length, endIndex);
					    startIndex = result[1].stdout.lastIndexOf('Mask:');
					    endIndex = result[1].stdout.indexOf('\n', startIndex);
					    netmask = result[1].stdout.substring(startIndex + 'Mask:'.length, endIndex);
					} else {
					    console.log('Failed to retrieve IP address information!');
					}
			    } else {
					console.log('Failed to execute IP address command!');
			    }
			    
			    ipResult([{available: available}, {ip: ip}, {netmask: netmask}]);
			};

			var changePassword = function (passwordCurrent, passwordNew, passwordNewVerify) {
				var promise = new Promise(function (resolve, reject) {
					if (passwordNew === passwordNewVerify) {
						onionConsole.getService('onion-session-provider', function (session) {
							session.checkLogin(passwordCurrent)
							.then(function () {
								onionConsole.getService('onion-ubus-provider', function (ubus) {
									ubus.request('file', 'exec', {
										command: 'change-password',
										params: [
											'-user', 'root',
											'-password', passwordNew,
											'-verify', passwordNew
										]
									}, function (data) {
										if (data.length === 2 && data[0] === 0) {
											resolve('You have successfully changed your password!');
										} else {
											reject(Error('Failed to change your password.'));
										}
									});
					            });
							}, function (err) {
								reject(Error('Current password is invalid.'));
							})
						});
					} else {
						reject(Error("New passwords don't match."));
					}
				});

				return promise;
			};

			var changeHostname = function (hostname) {
				var promise = new Promise(function (resolve, reject) {
					if (hostname !== '') {
						onionConsole.getService('onion-ubus-provider', function (ubus) {
							ubus.request('file', 'exec', {
								command: 'uci', 
								params: [
									'set', 
									'system.@system[0].hostname=' + hostname
								]
							}, function (result) {
								if (result[0] === 0) {
									ubus.request('uci', 'commit', {
										config: 'system'
									}, function (result) {
										if (result[0] === 0) {
											resolve('Hostname changed successfully.');
										}
									});
								} else {
									reject(Error('Unable to set the hostname.'));
								}
							});
						});
					} else {
						reject(Error('Hostname cannot be empty.'));
					}
				});

				return promise;
			};

			var changeTimezone = function (timezone, zonename) {
				var promise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-ubus-provider', function (ubus) {
						var timezonePromise = new Promise(function (resolve, reject) {
							ubus.request('file', 'exec', {
								command: 'uci', 
								params: [
									'set', 
									'system.@system[0].timezone=' + timezone
								]
							}, function (result) {
								if (result[0] === 0) {
									resolve();
								} else {
									reject();
								}
							});
						});

						var zonenamePromise = new Promise(function (resolve, reject) {
							ubus.request('file', 'exec', {
								command: 'uci', 
								params: [
									'set', 
									'system.@system[0].timezone=' + timezone
								]
							}, function (result) {
								if (result[0] === 0) {
									resolve();
								} else {
									reject();
								}
							});
						});

						// Once both of them are finished
						Promise.all([timezonePromise, zonenamePromise]).then(function () {
							ubus.request('uci', 'commit', {
								config: 'system'
							}, function (result) {
								if (result[0] === 0) {
									resolve('Timezone changed successfully.');
								} else {
									reject(Error('Unable to set the timezone.'));
								}
							});
						}, function () {
							reject(Error('Unable to set the timezone.'));
						});
					});
				});

				return promise;
			};
			
			var shutdown = function () {
				var shutdownPromise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-ubus-provider', function (ubus) {
						ubus.request('file', 'exec', {
							command: 'power-down', 
							params: [
								'-f'
							]
						}, function (result) {
							console.log(result);
							if (result[0] === 0) {
								resolve();
							} else {
								reject();
							}
						});
					});
				});

				return shutdownPromise;
			};

			var reboot = function () {
				var rebootPromise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-ubus-provider', function (ubus) {
						ubus.request('file', 'exec', {
							command: 'reboot', 
							params: [
								'-d', 
								'5',
								'&'
							]
						}, function (result) {
							console.log(result);
							if (result[0] === 0) {
								resolve();
							} else {
								reject();
							}
						});
					});
				});

				return rebootPromise;
			};

			Polymer({
				is: 'onion-device-provider',
				ready: ready,
				//update: update,
				noop: function () {},
				ready: ready,
				getMAC: getMAC,
				getSystem: getSystem,
				setMACResult: setMACResult,
				getRxTx: getRxTx,
				setRxTxResult: setRxTxResult,
				getIP: getIP,
				setIPResult: setIPResult,
				changePassword: changePassword,
				changeHostname: changeHostname,
				changeTimezone: changeTimezone,
				shutdown: shutdown,
				reboot: reboot
			});
        })();
	</script>
</dom-module>
