<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-ajax/iron-ajax.html">

<dom-module id="onion-ubus-provider">
	<template>
		<iron-ajax id="ajax" url="{{serverUrl}}" method="POST" content-type="application/json" on-response="handelResponse" handle-as="json"></iron-ajax> 
	</template>

	<script>
		'use strict';

		(function () {
			var self = null;

			var created = function () {
				self = this;
			};

			var openRequests = {};
			var requestCounter = 1;

			var request = function (pkg, funct, params, callback) {
				callback = callback || function () {};

				var body = {
					jsonrpc: '2.0',
					id: requestCounter,
					method: 'call',
					params: [self.token, pkg, funct, params]
				};

				openRequests[requestCounter] = callback;
				requestCounter += 1;
				
				self.$.ajax.body = JSON.stringify(body); 
				self.$.ajax.generateRequest();
			};

			var handelResponse = function (request) {
				var response = request.detail.response;

                if (response !== null) {
 				    if ('error' in response) {
					    openRequests[response.id]({error: response.error});
					    console.log(response.error);

					    // If access denied, log out
					    if (response.error.code === -32002) {
					    	onionConsole.getService('onion-session-provider', function (sessionProvider) {
								sessionProvider.logout();
							});
					    } 
				    } else {
					    openRequests[response.id](response.result);
				    }
				    
				    delete openRequests[response.id];
				} else {
				    self.isAlive = false;
					self.token = '00000000000000000000000000000000';
				}
			};


			Polymer({
				is: 'onion-ubus-provider',
				created: created,
	            properties: {
	            	token: {
	            		type: String,
	            		value: '00000000000000000000000000000000'
	            	},
	            	serverUrl: {
	            		type: String,
	            		value: window.location.origin + '/ubus'
	            		// value: "/ubus"

	            	},
					isAlive: {
					    type: Boolean,
						value: false
					}
	            },
	            request: request,
	            handelResponse: handelResponse
			});
        })();
	</script>
</dom-module>
