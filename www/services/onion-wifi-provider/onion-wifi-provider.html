<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/promise-polyfill/promise-polyfill-lite.html">

<dom-module id="onion-wifi-provider">
	<script>
		'use strict';

		(function () {
            var wifiProvider = null;
            var wifiScanResult = null;
            var wifiSetupResult = null;
            var apSetupResult = null;
		    var wpaKeyMinLength = 8;
			var wepKeyMinLength = 10;
			var wepKeyMaxLength = 26;
			var regEx = new RegExp(/^[0-9A-Fa-f]+$/);

            var ready = function () {
                wifiProvider = this;
                onionConsole.getService('onion-ubus-provider', function (ubus) {
                	wifiProvider.ubus = ubus;
				});			
            };

            var getConfig = function (type) {
            	var promise = new Promise(function (resolve, reject) {
            		wifiProvider.ubus.request('onion-console', 'wifi-info', {
            			params: {
            				type: type
            			}
            		}, function (data) {
            			if (data.length === 2 && data[0] === 0) {
            				resolve(data[1]);
            			}
            		})
            	});

            	return promise;
            };

            var wifiScan = function (callback) {
                var params = {
                    device: 'wlan0'
                };
                wifiScanResult = callback || this.noop;
                this.ubus.request('onion', 'wifi-scan', params, setWifiScanResult);
            };

            var setWifiScanResult = function (data) {
                if (data) {
                    var returnCode = data[0];
				    if (returnCode === 0) { 
				        if (data[1] !== null && data[1].results !== null) {
				            wifiScanResult({ wifiScan: data[1].results});
					    } else {
					        console.log('No available WiFi AP around');
					        wifiScanResult({ wifiScan: []});
					    }
				    } else {
				        console.log('WiFi scan failed!')
					    wifiScanResult({ wifiScan: []});
				    }
				} else {
				    console.log('WiFi scan failed!')
					wifiScanResult({ wifiScan: []});
				}
			};

			var wifiSetup = function (networkSsid, networkPassword, networkAuth, callback) {
				var params = {
					params: {
						ssid: networkSsid,
						password: networkPassword,
						auth: networkAuth
					}
				};
				wifiSetupResult = callback || this.noop;
				this.ubus.request('onion', 'wifi-setup', params, setWifiSetupResult);
			};

			var setWifiSetupResult = function (data) {
                if (data[0] !== null) {
				    var returnCode = data[0];
					if (returnCode === 0) {
				        console.log('WiFi Setup successfully!');
					    wifiSetupResult({wifiSetup: true});
					} else {
					    console.log('WiFi Setup failed, response: ' + data[0]);
					    wifiSetupResult({wifiSetup: false});
					}
                } else {
				    console.log('WiFi Setup failed!');
					wifiSetupResult({wifiSetup: false});
				}
            };
			
			var apSetup = function (networkSsid, networkPassword, networkAuth, callback) {
				var params = {
					params: {
						ssid: networkSsid,
						password: networkPassword,
						auth: networkAuth,
						accesspoint: ''
					}
				};
				apSetupResult = callback || this.noop;
				this.ubus.request('onion', 'wifi-setup', params, setApSetupResult);
			};
			
			var setApSetupResult = function (data) {
                if (data[0] !== null) {
				    var returnCode = data[0];
					if (returnCode === 0 && data[1].connecting === 'true') {
					    console.log('AP Setup successfully!');
						apSetupResult({apSetup: true});
					} else {
				        console.log('AP Setup failed, response: '+ data[0]);
					    apSetupResult({apSetup: false});
					}
                } else {
				    console.log('AP Setup failed!');
					apSetupResult({apSetup: false});
				}
			};
			
			var verifyKey = function(key, authType) {
			    var verfyResult = 'OK';
				var length = key.length;

				if (authType === 'psk' || authType === 'psk2') {
				    if (length < wpaKeyMinLength) {
						verfyResult = 'WPA/WPA2 key should be at least eight (8) characters long';
					}
				} else if (authType ==='wep') {
				    if (length !== wepKeyMinLength && length !== wepKeyMaxLength) {
					    verfyResult = 'WEP key should be ten (10) or twenty-six (26) characters long';
					} else {
						if (regEx.test(key) === false) {
						    verfyResult = 'WEP key should be a hexdecimal string';   
						}
					}
				}

			    return verfyResult;
			}
			
			Polymer({
				is: 'onion-wifi-provider',
				ready: ready,
				noop: function () {},
				ready: ready,
				getConfig: getConfig,
				wifiScan: wifiScan,
				setWifiScanResult: setWifiScanResult,
				wifiSetup: wifiSetup,
				setWifiSetupResult: setWifiSetupResult,
				apSetup: apSetup,
				setApSetupResult: setApSetupResult,
				verifyKey: verifyKey
			});
        })();
	</script>
</dom-module>
