<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/promise-polyfill/promise-polyfill-lite.html">

<dom-module id="onion-wifi-provider">
	<script>
		'use strict';

		(function () {
			var self = null;

			var created = function () {
				self = this;
			};

            var apSetupResult = null;
		    var wpaKeyMinLength = 8;
			var wepKeyMinLength = 10;
			var wepKeyMaxLength = 26;
			var regEx = new RegExp(/^[0-9A-Fa-f]+$/);

            var ready = function () {
                onionConsole.getService('onion-ubus-provider', function (ubus) {
                	self.ubus = ubus;
				});			
            };

            var getConfig = function (type) {
            	var promise = new Promise(function (resolve, reject) {
            		self.ubus.request('onion-console', 'wifi-info', {
            			params: {
            				type: type
            			}
            		}, function (data) {
            			if (data) {
            				if (data.length === 2 && data[0] === 0) {
	            				resolve(data[1]);
	            			}
            			}
            		})
            	});

            	return promise;
            };

            var wifiScan = function () {
                var promise = new Promise(function (resolve, reject) {
                	self.ubus.request('onion', 'wifi-scan', {
	                    device: 'wlan0'
	                }, function (data) {
	                	if (data) {
            				if (data.length === 2 && data[0] === 0) {
            					if (data[1] && data[1].results !== null) {
	            					resolve(data[1]);
	            				} else {
	            					reject(Error('No available WiFi AP around.'));
	            				}
	            			} else {
	            				reject(Error('Wi-Fi scan failed!'));
	            			}
            			} else {
            				reject(Error('Wi-Fi scan failed!'));
            			}
					});
                });

	            return promise;
            };

			var wifiSetup = function (enableWifi, networkSsid, networkPassword, networkAuth) {
				var params = enableWifi ? {
					params: {
						ssid: networkSsid,
						password: networkPassword,
						auth: networkAuth
					}
				} : {
					params: {
						killsta: ''
					}
				};
				
				var promise = new Promise(function (resolve, reject) {
					self.ubus.request('onion', 'wifi-setup', params, function (data) {
						if (data.length === 2 && data[0] === 0) {
							resolve();
						} else {
							reject(Error('Unable to connect to Wi-Fi.'));
						}
		            });
				});

				return promise;
			};
			
			var apSetup = function (enabledAP, apSsid, apPassword, apAuth, apIp) {
				var params = enabledAP ? {
					params: {
						ssid: apSsid,
						password: apPassword,
						auth: apAuth,
						ip: apIp,
						accesspoint: ''
					}
				} : {
					params: {
						killap: ''
					}
				};

				var promise = new Promise(function (resolve, reject) {
					self.ubus.request('onion', 'wifi-setup', params, function (data) {
						if (data) {
							if (data.length === 2 && data[0] === 0) {
								resolve();
							} else {
								reject(Error('Unable to setup Access Point.'));
							}
						} else {
							reject(Error('Unable to setup Access Point.'));
						}
					});
				});

				return promise;
			};
						
			var verifyKey = function (key, authType) {
			    var verfyResult = 'OK';
				var length = key.length;

				if (authType === 'psk' || authType === 'psk2') {
				    if (length < wpaKeyMinLength) {
						verfyResult = 'WPA/WPA2 key should be at least eight (8) characters long';
					}
				} else if (authType === 'wep') {
				    if (length !== wepKeyMinLength && length !== wepKeyMaxLength) {
					    verfyResult = 'WEP key should be ten (10) or twenty-six (26) characters long';
					} else {
						if (regEx.test(key) === false) {
						    verfyResult = 'WEP key should be a hexdecimal string';   
						}
					}
				}

			    return verfyResult;
			};
			
			Polymer({
				is: 'onion-wifi-provider',
				created: created,
				ready: ready,
				noop: function () {},
				ready: ready,
				getConfig: getConfig,
				wifiScan: wifiScan,
				wifiSetup: wifiSetup,
				apSetup: apSetup,
				verifyKey: verifyKey
			});
        })();
	</script>
</dom-module>
