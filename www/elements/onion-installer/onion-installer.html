<link rel="import" href="../../lib/polymer/polymer.html">
<link rel="import" href="../../elements/onion-loading/onion-loading.html">

<dom-module id="onion-installer">
	<style>

	</style>

	<template>

		<div>
			<h3>
				{{infoText}}
			</h3>
			<bootstrap-button color-scheme="success" on-tap="installApp">Click here to install the {{installName}} App!</bootstrap-button>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			var created = function () {

			};

			var ready = function(){
				var app = this.installId;
				this.showApp(app);
				onionConsole.getService('onion-device-provider', function (err,deviceProvider){
					if(!err){
						this.deviceProvider = deviceProvider;
					}
				}.bind(this));
				onionConsole.getService('onion-file-provider', function (err,fileProvider){
					if(!err){
						this.fileProvider = fileProvider;
					}
				}.bind(this));
			};

			var showApp = function (installId) {
				onionConsole.importHref(['./apps/' + installId + '/' + installId + '.html?r=a2'], function () {
					console.log("Inside the callback for the this.importHref");
					var appElement = document.createElement(installId);
					console.log("App element:", installId);
					appElement.setAttribute('id', installId);
					Polymer.dom(onionConsole.$.appContainer).appendChild(appElement); 
					onionConsole.set('currentApp', installId);
					if (typeof fileName !== 'undefined') {
						appElement.fileName=fileName;
					}
				});
			}
			
			var installApp = function () {
				var params = {};
				var key = this.installName.toLowerCase();
				params[key] = "1"
				this.deviceProvider.callService('', 'uci', 'set', {
					config: 'onion',
					section: 'console',
					values: params
				}, function (err,result) {
					if (!err) {
						this.deviceProvider.callService('', 'uci', 'commit', {
							config: 'onion'
						}, function (err, result) {
							if (!err) {
								// resolve('App install status changed successfully.');
								// checkForApp(this.installId);
								this.fileProvider.execBackgroundCommand(null,'console-install-tool',[],function(err,result){
									console.log("err",err);
									console.log('resut',result);
									console.log("InstallId",this.installId);
									this.checkForApp(this.installId);
								}.bind(this));
							}
						}.bind(this));
					} else {
						reject(Error('Unable to set the install status.'));
					}
				}.bind(this));
			};
			

			var checkForApp = function (appId){
				console.log("Inside checkForApp, appId", appId);
				var self = this;
				if(appId == 'onion-terminal'){
					this.appPackage = 'onion-console-terminal';
					this.checkInstallInterval = setInterval(this.checkInstallFunction,10000);
				}else if(appId == 'onion-editor'){
					this.appPackage = 'onion-console-editor';
					this.checkInstallInterval = setInterval(this.checkInstallFunction,10000);
				}else if(appId == 'onion-webcam'){
					this.appPackage = 'onion-console-webcam';
					this.checkInstallInterval = setInterval(this.checkInstallFunction,10000);
				}
			};

			var appFoundObserver = function(e,y){
				//e is the new value
				//y is the old value
				console.log("appFoundObserver gets called");
				console.log(e);
				if(e){
					//clear the interval
					clearInterval(this.checkInstallInterval);
				}
			};

			var checkInstallFunction = function(){
				console.log("Inside checkInstallFunction");
				console.log("this",this);
				onionConsole.getService('onion-file-provider',function(err,fProvider){
					if(!err){
						fProvider.execCommand(null,'opkg',['list-installed'],function(err,data){
							console.log("Inside the checkInstall Callback");
							console.log("Err",err);
							console.log("data",data);
							if(data.code == '0'){
								var result = new String(data.stdout);
								if(result.indexOf(this.appPackage) > 0){
									this.appFound = true;
								}else{
									this.appFound = false;
								}
							}
						}.bind(this));
					}
				})
			};

			Polymer({
				is: 'onion-installer',
				created: created,
				ready: ready,
				installApp: installApp,
				showApp: showApp,
				appFoundObserver: appFoundObserver,
				checkForApp: checkForApp,
				checkInstallFunction: checkInstallFunction,
				properties: {
					installName: String,
					installId: String,
<<<<<<< HEAD
					appFound:{
						type:Boolean,
						value:false,
						notify:true,
						observer: 'appFoundObserver'
					},
					infoText: {
						type:String,
						notify:true,
						value:""},
					runningApps: {
						type: Array,
						notify: true,
						value: []
					},
					currentApp: {
						type: String,
						notify: true,
						value: ''
					},
					appPackage:{
						type: String,
						notify: true,
						value: ''
					}
=======
					infoText: String
>>>>>>> origin/dev
				},
			});
		})();
	</script>
</dom-module>
