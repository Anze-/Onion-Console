<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/lib/iron-pages/iron-pages.html">

<dom-module id="onion-console">
	<style>
		:host {
			display: block;
			height: 100%;
			width: 100%;
			overflow: hidden;

			background-image: url('/images/bg/a.jpg');
		    background-attachment: fixed;
		    background-size: cover;
		}

		#appContainer {
			width: 100%;
			height: 100%;
		}
	</style>

	<template>
		<iron-pages id="appContainer" attr-for-selected="id" selected="{{currentApp}}"></iron-pages>
		<div id="serviceContainer" class="hidden"></div>
	</template>

	<script>
		'use strict';

		(function () {
			var services = {};

			var launchService = function (serviceId, callback) {
				callback = callback || this.noop;

				if (!services[serviceId]) {
					this.importHref(['/services/' + serviceId + '/' + serviceId+ '.html'], function () {
						var serviceElement = document.createElement(serviceId);
						Polymer.dom(this.$.serviceContainer).appendChild(serviceElement);

						services[serviceId] = serviceElement;

						callback(serviceElement);
					});
				}
			};

			var launchApp = function (appId, relaunch) {
				if (this.$.appContainer.querySelector(appId)) {
					onionConsole.$.appContainer.querySelector(appId).fg();
					this.currentApp = appId;

					if (relaunch) {
						onionConsole.$.appContainer.querySelector(appId).start();
					}
				} else {
					this.importHref(['/apps/' + appId + '/' + appId + '.html'], function () {
						var appElement = document.createElement(appId);
						appElement.setAttribute('id', appId);
						Polymer.dom(this.$.appContainer).appendChild(appElement); 

						this.currentApp = appId;
					});
				}
			};

			var ready = function () {
				window.onionConsole = this;
			};

			var attached = function () {
				this.launchApp('onion-login');
			};

			var getService = function (serviceId, callback) {
				if (serviceId in services) {
					callback(services[serviceId]);
				} else {
					this.launchService(serviceId,callback);
				}
			};

			Polymer({
				is: 'onion-console',
				noop: function () {},
				ready: ready,
				attached: attached,
				launchApp: launchApp,
				launchService: launchService,
				getService: getService
			});
		})();
	</script>
</dom-module>
