<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="/elements/bootstrap-styles/bootstrap-styles.html">
<link rel="import" href="./bootstrap-modal-header.html">
<link rel="import" href="./bootstrap-modal-body.html">
<link rel="import" href="./bootstrap-modal-footer.html">

<dom-module id="bootstrap-modal">
	<template>
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<content></content>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			var self = null;

			var created = function () {
				self = this;
			};

			var _updateClosingReasonConfirmed = function (confirmed) {
				self.closingReason = self.closingReason || {};
				self.closingReason.confirmed = confirmed;
			};

			var _onDialogClick = function (event) {
				var target = event.target;

				while (target && target !== self) {
					if (target.hasAttribute) {
						if (target.hasAttribute('dialog-dismiss')) {
							self._updateClosingReasonConfirmed(false);
							self.close();
							break;
						} else if (target.hasAttribute('dialog-confirm')) {
							self._updateClosingReasonConfirmed(true);
							self.close();
							break;
						}
					}

					target = target.parentNode;
				}
			};

			var _onIronOverlayOpened = function () {
				if (self.modal) {
					document.body.addEventListener('focus', self._boundOnFocus, true);
					self.backdropElement.addEventListener('click', self._boundOnBackdropClick);
				}
			};

			var _onIronOverlayClosed = function () {
				document.body.removeEventListener('focus', self._boundOnFocus, true);
				self.backdropElement.removeEventListener('click', self._boundOnBackdropClick);
			};

			var _onFocus = function (event) {
				if (self.modal) {
					var target = event.target;
					while (target && target !== self && target !== document.body) {
						target = target.parentNode;
					}

					if (target) {
						if (target === document.body) {
							if (self._lastFocusedElement) {
								self._lastFocusedElement.focus();
							} else {
								self._focusNode.focus();
							}
						} else {
							self._lastFocusedElement = event.target;
						}
					}
				}
			};

			var _onBackdropClick = function () {
				if (self.modal) {
					if (self._lastFocusedElement) {
						self._lastFocusedElement.focus();
					} else {
						self._focusNode.focus();
					}
				}
			};

			Polymer({
				is: 'bootstrap-modal',
				created: created,
				behaviors: [Polymer.IronOverlayBehavior],
				hostAttributes: {
					role: 'dialog',
					tabindex: '-1'
				},
				properties: {
					closeButton: {
						type: Boolean,
						value: false
					},
					withBackdrop: {
						type: Boolean,
						value: true
					},
					_lastFocusedElement: {
						type: Object
					},
					_boundOnFocus: {
						type: Function,
						value: function () {
							return self._onFocus.bind(self);
						}
					},
					_boundOnBackdropClick: {
						type: Function,
						value: function () {
							return self._onBackdropClick.bind(self);
						}
					}
				},
				listeners: {
					'tap': '_onDialogClick',
					'iron-overlay-opened': '_onIronOverlayOpened',
					'iron-overlay-closed': '_onIronOverlayClosed'
				},
				_updateClosingReasonConfirmed: _updateClosingReasonConfirmed,
				_onDialogClick: _onDialogClick,
				_onIronOverlayOpened: _onIronOverlayOpened,
				_onIronOverlayClosed: _onIronOverlayClosed,
				_onFocus: _onFocus,
				_onBackdropClick: _onBackdropClick
			});
		})();
	</script>
</dom-module>