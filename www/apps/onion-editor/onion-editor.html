<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/lib/juicy-ace-editor/src/juicy-ace-editor.html">
<link rel="import" href="/lib/iron-icons/iron-icons.html">
<link rel="import" href="/elements/onion-app/onion-app.html">
<link rel="import" href="/lib/Onion-Console/bootstrap-modal/bootstrap-modal.html">
<link rel="import" href="/elements/onion-file-list/onion-file-list.html">
<link rel="import" href="/elements/onion-loading/onion-loading.html">
<link rel="import" href="/elements/bootstrap-modal/bootstrap-modal.html">
<dom-module id="onion-editor">
	<style>
		:host {
		    display: block;
	  	    height: 100%;
			width: 100%;
		}

		onion-app-body > div {
			height: 100%;
			width: 100%;
		}

		#side-bar {
			width: 300px;
			height: 100%;
			position: relative;
		}

			#current-folder {
				font-size: 13px;
				position: absolute;
				top: 0;
				width: 100%;
			    color: black;
			    background-color: #bdc3c7;
				font-family: monospace;
				padding: 10px;
	            line-height: 20px;
	            z-index: 10;
			}

			onion-file-list {
				width: 100%;
				height: 100%;
				padding-top: 40px;
				background-color: #ecf0f1;
				overflow: scroll;
			}

		#editor-container {
		    width: 100%;
			height: 100%;
		}

	    #fileEditor {
	        width: 100%;
	        height: 100%;
	    }
		#toast1 {
		    margin-left:20%;
		}
		.horizontal-section {
			padding: 0 !important;
        }
		paper-item {
			--paper-item: {
				cursor: pointer;
			};
		}

		onion-app-toolbar button {
			padding: 0 10px;
			background-color: transparent;
		}
			onion-app-toolbar button:hover {
				background-color: rgba(255, 255, 255, 0.5);
			}
		onion-app-toolbar button > iron-icon {
			margin-right: 5px;
		}

		:host ::content .ace_search_field {
			color: #333!important;
		}
	</style>
	<template>
		<onion-app app-name="Editor" toolbar-background="#34495e" toolbar-color="#fff">
			<onion-app-toolbar page-id="home">
				<div class="layout horizontal">
					<div class="flex">
						<button on-click="launchUploadFile" id="uploadFileButton"><iron-icon class="toolbar-icon" icon="icons:folder"></iron-icon><span>Upload File</span></button>
						<button on-click="newFolderDialog"><iron-icon class="toolbar-icon" id="newFolderButton" icon="icons:folder"></iron-icon><span>New Folder</span></button>
						<button on-click="newFileDialog"><iron-icon class="toolbar-icon" id="newFileButton" icon="icons:note-add"></iron-icon><span>New File</span></button>
						<button on-click="deleteFolderDialog" disabled="disabled" id="deleteFolderButton"><iron-icon class="toolbar-icon" icon="icons:delete"></iron-icon><span>Delete Folder</span></button>
						<button on-click="deleteFileDialog" disabled="disabled" id="deleteFileButton"><iron-icon class="toolbar-icon" icon="icons:delete"></iron-icon></span><span>Delete File</span></button>
						<button on-click="renameFolderDialog" disabled="disabled" id="renameFolderButton"><iron-icon class="toolbar-icon" icon="icons:create"></iron-icon></span><span>Rename Folder</span></button>
					    <button on-click="renameFileDialog" disabled="disabled" id="renameFileButton"><iron-icon class="toolbar-icon" icon="icons:create"></iron-icon></span><span>Rename File</span></button>
					</div>
					<div>
						<button id="saveFileButton" on-click="saveFile"><iron-icon class="toolbar-icon" icon="icons:check"></iron-icon><span>Save</span></button>
						<button id="closeFileButton" on-click="closeFile"><iron-icon class="toolbar-icon" icon="icons:close"></iron-icon><span>Close</span></button>
					</div>
				</div>
			</onion-app-toolbar>

			<onion-app-body page-id="home">
				<div class="horizontal layout">
					<div id="side-bar">
					    <div id="current-folder">{{currentFolder}}</div>
						<onion-file-list id="fileList" files="{{files}}">No File</onion-file-list>
					</div>
					<div id="editor-container" class="flex">
						<onion-loading id="loadingIcon"></onion-loading>
						<bootstrap-modal id="fileUploadDialog" title="Upload A File!">
							<modal-body>
								<form action="/cgi-bin/cgi-upload" method="post" enctype="multipart/form-data">
									<input id="fileSelectionInput" type="file" name="file"></input>
									<input id="fileSelectionButton" type="submit" name="Submit" value="Submit Form">Upload!</input>
								</form>
							</modal-body>
						</bootstrap-modal>
					    <juicy-ace-editor id="fileEditor" theme="ace/theme/monokai" mode="ace/mode/text" fontsize="13px"></juicy-ace-editor>
					</div>
				</div>
			</onion-app-body>
		</onion-app>	
	</template>
	<script>
		'use strict';
		(function () {
			// var this = null;

			var created = function () {
				// this = this;
			};

			var submitUpload = function(){
				// console.log(this.$.fileSelectionInput.value);
			};

			var showLoadingScreen = function(){
				this.$.loadingIcon.loading = true;
				this.$.fileEditor.hidden = true;
			};

			var hideLoadingScreen = function(){
				this.$.loadingIcon.loading = false;
				this.$.fileEditor.hidden = false;
			};

			// var folderFileInfo = null;
			var backsplash = null;
			var extSymbol = null;

			var launchUploadFile = function(){
				this.$.fileUploadDialog.open();
				// setTimeout(function(){
				// 	this.$.fileUploadDialog.close();
				// }.bind(this),6000);
			};

			var hideFileButtons = function(){
				this.$.saveFileButton.disabled=true;
				this.$.closeFileButton.disabled=true;
				this.$.renameFileButton.disabled=true;
				this.$.deleteFileButton.disabled=true;
				this.$.saveFileButton.hidden=true;
				this.$.closeFileButton.hidden=true;
				this.$.renameFileButton.hidden=true;
				this.$.deleteFileButton.hidden=true;
			};

			var showFileButtons = function(){
				this.$.saveFileButton.disabled=false;
				this.$.closeFileButton.disabled=false;
				this.$.renameFileButton.disabled=false;
				this.$.deleteFileButton.disabled=false;
				this.$.saveFileButton.hidden=false;
				this.$.closeFileButton.hidden=false;
				this.$.renameFileButton.hidden=false;
				this.$.deleteFileButton.hidden=false;
			};

			var ready = function () {
				this.backsplash = '/';
				this.extSymbol = '.';
				this.fileName = '';
				
				this.folderFileInfo = {
					folder: this.backsplash, //current folder
					file: '',           //current file
					list: null,         
					fileInEdit: ''      //current folder + current file
				};

				// setInterval(function(){
				// 	if(this.folderFileInfo.fileInEdit == ''){
				// 		console.log("fileInEdit == ''");
				// 		// Means no file has been selected, disable the save,close,renamefile and deleteFile Buttons
				// 		this.$.saveFileButton.disabled=true;
				// 		this.$.closeFileButton.disabled=true;
				// 		this.$.renameFileButton.disabled=true;
				// 		this.$.deleteFileButton.disabled=true;
				// 		this.$.saveFileButton.hidden=true;
				// 		this.$.closeFileButton.hidden=true;
				// 		this.$.renameFileButton.hidden=true;
				// 		this.$.deleteFileButton.hidden=true;
				// 	} else{
				// 		this.$.saveFileButton.disabled=false;
				// 		this.$.closeFileButton.disabled=false;
				// 		this.$.renameFileButton.disabled=false;
				// 		this.$.deleteFileButton.disabled=false;
				// 		this.$.saveFileButton.hidden=false;
				// 		this.$.closeFileButton.hidden=false;
				// 		this.$.renameFileButton.hidden=false;
				// 		this.$.deleteFileButton.hidden=false;
				// 	}						//If there is no file in edit

				// }.bind(this),2000);

				onionConsole.getService('onion-session-provider', function (err, sessionProvider) {
					this.sessionProvider = sessionProvider;
					if (sessionProvider.isAlive() === true) {   
						onionConsole.getService('onion-file-provider', function (err, fileProvider) {
							this.fileProvider = fileProvider;
							this.$.fileList.addEventListener('click', function (e) {
								console.log("Single Event click is called");
								console.log("FileList");
								console.log(this.$.fileList);
								if (typeof e.target.icon === 'undefined') {
									console.log(e);
									if(this.folderFileInfo.file != e.target.textContent){
										this.openFolder(e.target.textContent);
									}
								}
							}.bind(this));
							this.$.fileList.addEventListener('dblclick', function (e) {
								console.log("Double Click Event is Called");
								console.log("FileList");
								console.log(this.$.fileList);
								if (typeof e.target.icon === 'undefined') {
									console.log(e);
					               	if(this.folderFileInfo.file != e.target.textContent){
										this.openFolder(e.target.textContent);
									}
								}
							}.bind(this));
							if(this.fileName==='') {
							    this.openFolder(this.backsplash);
							} else {
								this.openFolder(this.fileName);
							}
						}.bind(this));
					}
				}.bind(this));	
			};
			 
			var findTypeById = function (sourceList, name) {
			    var result = '';

				if (sourceList !== null) {
				    for (var i = 0; i < sourceList.length; i++) {
					    if (sourceList[i].name === name) {
					        result = sourceList[i].type;
					    }
				    }
				}

				return result;
			};
			 
			var isFileChanged = function () {
			    var changed = false;
			    if (this.folderFileInfo.fileInEdit !== '' &&	this.currentCode !== this.$.fileEditor.editor.session.getValue()) {
				    changed = true;
				}

				return changed;
			};
			
			var getFileExtension = function () {
			    var extension = '';

			    if (this.folderFileInfo.file !== '') {
			        extension = this.folderFileInfo.file.substring(this.folderFileInfo.file.lastIndexOf(this.extSymbol) + 1, this.folderFileInfo.file.length);
			    }

				return extension;
			};

			var getLang = function(extension){
				if(extension == 'js'){
					return 'javascript';
				} else if(extension == 'py'){
					return 'python';
				} else if(extension == 'html'){
					return 'html';
				}
			}
			
			var openFolder = function (path) {
				console.log(path);
				var currentFile = '';
                if (this.sessionProvider.isAlive() === true) {
					var changed = true;
					console.log("Inside the openFolder Function");
				    onionConsole.getService('onion-file-provider', function (err, fileProvider) {
				 	    this.fileProvider = fileProvider;
						console.log("Inside the file-provider get service");
						//launch app with specified file
						console.log(this.fileName);
						if(this.fileName!=='') {
							console.log("Inside the this.this.fileName if statement");							
							var loadFolderName=fileProvider.getFolderPath(this.fileName);
							var loadfileName=fileProvider.getFileName(this.fileName);
								console.log('Load folder:'+loadFolderName);
								console.log('Load file:'+loadfileName);
								folderFileInfo.folder=loadFolderName;
							
							fileProvider.getFolderContent(null, folderFileInfo.folder, function (result) {
								console.log("Inside getFolderContent Callback and result is", result);
								if (result.status == 'success') {
								    this.currentFolder = this.folderFileInfo.folder
									this.folderFileInfo.list = result.list;
									console.log(result.list);
									result.list.forEach(function(element,index){
										console.log(element)
										if(element.type=='directory'){
											element.preview ='folder';
										}
									});
									this.files = result.fileList;
	                                this.$.fileList.setAttribute('files', JSON.stringify(this.folderFileInfo.list));										
								}
							}.bind(this));
							path=loadfileName;
							this.fileName='';
						}
						
						if (path.match(/\r?\n|\r/g) !== null) {
						    console.log("multiple selection, do nothing");
							return;
						} else if(path === '..') {
						    if (this.folderFileInfo.folder === this.backsplash || this.folderFileInfo.folder.lastIndexOf(this.backsplash) === 0) {
							    path = this.backsplash;
						    } else {
							    path = this.folderFileInfo.folder.substring(0, this.folderFileInfo.folder.lastIndexOf(this.backsplash));
                            }
					    } else {
						    if (path === this.folderFileInfo.folder) {
				                changed = false;   
							} else if (findTypeById(this.folderFileInfo.list, path) === 'directory') {
							    if (this.folderFileInfo.folder === this.backsplash) {
								    path = this.folderFileInfo.folder + path;
							    } else {
								    path = this.folderFileInfo.folder + this.backsplash + path;
							    }
						    } else {
							    currentFile = path;
						    }
					    }
						
					    if (changed === false || currentFile === '') {
						    this.folderFileInfo.folder = path;
							if (this.folderFileInfo.folder !== this.backsplash) {
							    this.$.deleteFolderButton.disabled = false;
								this.$.renameFolderButton.disabled = false;
							} else {
							    this.$.deleteFolderButton.disabled = true;
								this.$.renameFolderButton.disabled = true;
							}
                            //Get file list			
                            console.log('onion-editor open folder:'+this.folderFileInfo.folder);							
                            fileProvider.getFolderContent(null,this.folderFileInfo.folder, function (result) {
                            	console.log("Inside getFolderContent callback 2 and result is",result);
							    this.currentFolder = this.folderFileInfo.folder;	
							    this.folderFileInfo.list = result.list;
							   	result.list.forEach(function(element,index){
										console.log(element)
										if(element.type=='directory'){
											element.preview ='folder';
										}
									});
							    this.$.fileList.setAttribute('files', JSON.stringify(result.list));									
						    }.bind(this));
					    } else {
					    	console.log(currentFile);
					    	console.log(this.folderFileInfo);
					        this.folderFileInfo.file = currentFile;
						    console.log('It\'s a file[' + this.folderFileInfo.folder + this.folderFileInfo.file + ']');
							this.openFile();
					    }
				    }.bind(this));
				}
			};
			
			var openFile = function () {
				this.showLoadingScreen();
			    this.closeFile(function(){
			    	console.log("Inside the openFile");
				    console.log("folderFileInfo",this.folderFileInfo);
				    if (this.sessionProvider.isAlive() === true && this.folderFileInfo.file !== '') {
					    var ext = this.getFileExtension();
					    console.log("Inside the ifstatement");
					    console.log(ext);
					    var lang = getLang(ext);
						this.$.fileEditor.editor.session.setMode('ace/mode/' + lang);
						// this.$.fileEditor.mode = 'ace/mode/' + lang;

	                    onionConsole.getService('onion-file-provider', function (err, fileProvider) {

						    this.fileProvider = fileProvider;
						    //Get file list
						    if(this.folderFileInfo.folder == this.backsplash){
						    	var path = this.folderFileInfo.folder + this.folderFileInfo.file;
						    } else{
						    	var path = this.folderFileInfo.folder + this.backsplash + this.folderFileInfo.file;
						    }					   
						    console.log(path);
							fileProvider.getFile(null,path, function (result) {
								console.log("Result, inside of the callback");
								console.log(result);
							    if (result.status === 'success') {
							        this.currentCode = result.data;
							        this.$.fileEditor.editor.session.setValue(result.data);
							        this.showFileButtons();
							        if(this.folderFileInfo.folder == this.backsplash){
							        	this.folderFileInfo.fileInEdit = this.folderFileInfo.folder + this.folderFileInfo.file;
							        } else{
										this.folderFileInfo.fileInEdit = this.folderFileInfo.folder + this.backsplash + this.folderFileInfo.file;	        	
							        }
									this.$.deleteFileButton.disabled = false;
									this.$.renameFileButton.disabled = false;
									this.hideLoadingScreen();
								} else {    
								    alert('Failed to open \"' + this.folderFileInfo.folder + this.backsplash + this.folderFileInfo.file + '\"');
								    this.hideLoadingScreen();								
								}
						    }.bind(this));
					    }.bind(this));
					}
				}.bind(this));
			 //    console.log("Inside the openFile");
			 //    console.log("folderFileInfo",this.folderFileInfo);
			 //    if (this.sessionProvider.isAlive() === true && this.folderFileInfo.file !== '') {
				//     var ext = this.getFileExtension();
				//     console.log("Inside the ifstatement");
				//     console.log(ext);
				// 	this.$.fileEditor.editor.session.setMode('ace/mode/' + ext);
				// 	this.$.fileEditor.mode = 'ace/mode/' + ext;

    //                 onionConsole.getService('onion-file-provider', function (err, fileProvider) {

				// 	    this.fileProvider = fileProvider;
				// 	    //Get file list
				// 	    if(this.folderFileInfo.folder == this.backsplash){
				// 	    	var path = this.folderFileInfo.folder + this.folderFileInfo.file;
				// 	    } else{
				// 	    	var path = this.folderFileInfo.folder + this.backsplash + this.folderFileInfo.file;
				// 	    }
					   
				// 	    console.log(path);
				// 	    console.log(path);
				// 		fileProvider.getFile(null,path, function (result) {
				// 			console.log("Result, inside of the callback");
				// 			console.log(result);
				// 		    if (result.status === 'success') {
				// 		        // this.currentCode = result.data;
				// 		        this.$.fileEditor.editor.session.setValue(result.data);
				// 		        if(this.folderFileInfo.folder == this.backsplash){
				// 		        	this.folderFileInfo.fileInEdit = this.folderFileInfo.folder + this.folderFileInfo.file;
				// 		        } else{
				// 					this.folderFileInfo.fileInEdit = this.folderFileInfo.folder + this.backsplash + this.folderFileInfo.file;						        	
				// 		        }
				// 				this.$.deleteFileButton.disabled = false;
				// 				this.$.renameFileButton.disabled = false
				// 			} else {    
				// 			    alert('Failed to open \"' + this.folderFileInfo.folder + this.backsplash + this.folderFileInfo.file + '\"');								
				// 			}
				// 	    }.bind(this));
				//     }.bind(this));
				// }
            };
			
			var closeFile = function (callback) {
				var bdisplayMsg;
				if(this.folderFileInfo.fileInEdit === ""){
					bdisplayMsg = true;
				} else{
					bdisplayMsg = confirm('Do you want to close \"' + this.folderFileInfo.fileInEdit + '\" ?');
				}
				if(bdisplayMsg){
					this.hideFileButtons();
				    if (this.sessionProvider.isAlive() === true && this.folderFileInfo.file !== '') {
				        if (this.isFileChanged()) {
						    if (confirm('Do you want to save \"' + this.folderFileInfo.fileInEdit + '\" ?')) {
						    	console.log(this.folderFileInfo.fileInEdit);
						    	this.saveFile(function(result){
						    		console.log("Inside closeFile callback");
						    		if(typeof callback === 'function'){
						    			//Means it doesnt get called from the button
						    			callback();
						    		}else{
							    		this.$.fileEditor.editor.session.setValue('');
							    		this.currentCode = '';
							    		this.folderFileInfo.file='';
							    		this.folderFileInfo.fileInEdit = '';
						    		}
						    		// this.$.fileEditor.editor.session.setValue('');
						    		// this.currentCode = '';
						            // this.folderFileInfo.fileInEdit = '';

						    	}.bind(this));
							    // if (typeof this.saveFile() === 'boolean') {
								    // this.currentCode = '';
						      //       this.folderFileInfo.fileInEdit = '';
								// }
							} else{
								this.$.fileEditor.editor.session.setValue('');
							    this.currentCode = '';
							    this.folderFileInfo.file='';
							    this.folderFileInfo.fileInEdit = '';
							}
					    } else {
						    // this.currentCode = '';
						    this.$.fileEditor.editor.session.setValue('');
						    this.folderFileInfo.fileInEdit = '';
						    if(typeof callback === 'function'){
						    	console.log("Its called from opening another file");
						    	console.log("This is the folderInfoFile.file",this.folderFileInfo.file);
						    } else{
						    	console.log("Its called from closeButton");
						    	this.folderFileInfo.file = '';
						    }
						}
						this.$.deleteFileButton.disabled=true;
						this.$.renameFileButton.disabled=true;
						if(typeof callback === 'function'){
							callback();
						}
				    }
				} else{
					if(typeof callback === 'function'){
						callback();
					}
				}
			};
			
			var saveFile = function (callback) {
			    //var saveResult=true;
				if (this.sessionProvider.isAlive() === true && this.folderFileInfo.fileInEdit !== '') {	
				    onionConsole.getService('onion-file-provider', function (err, fileProvider) {
					    this.fileProvider = fileProvider;
					    //Get file list
						var codeInEdit = this.$.fileEditor.editor.session.getValue();
					    fileProvider.saveContent(null,this.folderFileInfo.fileInEdit, codeInEdit,false, function (result) {
					    	console.log(result);
						    if (result.status == 'success') {
							    this.currentCode = codeInEdit;
						        alert('\"' + this.folderFileInfo.fileInEdit + '\" saved successfully!!');
						        if(typeof callback === 'function'){
						        	callback(result);
						        }
							} else {    
							    alert('Failed to save \"' + this.folderFileInfo.fileInEdit + '\"');
							    if(typeof callback === 'function'){
							    	callback(result);
							    }
								//saveResult=false;
							}
					    }.bind(this));
				    }.bind(this));
				}
				//return saveResult;
			};
			
			var newFolderDialog = function () {
				var folderName = prompt('Please enter new folder name');
				
				if (folderName !== null) {
				    this.createFile('folder', folderName);
				}
			};
			
			var newFileDialog = function () {
				var fileName = prompt('Please enter new file name');

				if (fileName !== null) {
				    this.createFile('file', fileName);
				}
			};
			
			var deleteFileDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.fileInEdit !== '') {	
                    if (confirm('Are you sure that you want to permanently delete \"' + this.folderFileInfo.fileInEdit + '\" ?')) {
                    	console.log(this.folderFileInfo.fileInEdit);
                        this.deleteFile('file', this.folderFileInfo.fileInEdit);			  
					}	   
			    }
			};
			
			var deleteFolderDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.folder) {
                    if (this.folderFileInfo.folder === this.backsplash) {
                        alert('Delete all folders and files under root directory will make the system no long in function! Operation aborted!!'); 
                    } else {
                        if (confirm('Are you sure that you want to permanently delete \"' + this.folderFileInfo.folder + '\" folder?\nWarning!! All the folders and files under \"' + this.folderFileInfo.folder + '\" will be deleted!')) {
                        	console.log("folderFileInfo.folder",this.folderFileInfo.folder);
                            this.deleteFile('folder', this.folderFileInfo.folder);					   
                        }
					}	   
			    }
			};
			
			var renameFileDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.fileInEdit !== '') {	
				    var fileName = prompt('Please enter new file name');
					if (fileName !== null) {
                        this.renameFile('file', fileName);			  	   
					}
			    }
			};
			
			var renameFolderDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.folder !== this.backsplash) {	
				    var folderName = prompt('Please enter new folder name');
					if (folderName !== null) {
                        this.renameFile('folder', folderName);		
                    }						
			    }
			};
						
			var deleteFile = function (type, fileName) {
				console.log("fileName",fileName);
			   if (this.sessionProvider.isAlive() === true ) {
				    onionConsole.getService('onion-file-provider', function (err, fileProvider) {
					    this.fileProvider = fileProvider;
					    console.log("fileName",fileName);
						fileProvider.remove(null,fileName, function (result) {
						    if (result.status=='success') {
							    this.currentCode = '';
								this.folderFileInfo.fileInEdit = '';
								if (type === 'folder') {
								    if (this.folderFileInfo.folder === this.backsplash || this.folderFileInfo.folder.lastIndexOf(this.backsplash) === 0) {
							            this.folderFileInfo.folder = this.backsplash;
						            } else {
							            this.folderFileInfo.folder = this.folderFileInfo.folder.substring(0, this.folderFileInfo.folder.lastIndexOf(this.backsplash));
								    }
								}

								this.openFolder(this.folderFileInfo.folder);
								alert('\"' + fileName + '\" deleted successfully!!');
								this.$.fileEditor.editor.session.setValue('');
								this.currentCode = '';
					        } else {    
							    alert('Failed to delete \"' + fileName + '\"');
							}
					    }.bind(this));
					}.bind(this));
				} else {
				    alert('Session time out! Failed to delete Folder or File!');
				}
			};
			
			var createFile = function (type, fileName) {
			    if (fileName === '') {
				    alert('Invalid ' + type + ' name!!');
					return;
				}
			    if (this.sessionProvider.isAlive() === true ) {
				    onionConsole.getService('onion-file-provider', function (err, fileProvider) {

					    this.fileProvider = fileProvider;
						var newfileName = '';

						if (this.folderFileInfo.folder === this.backsplash) {
						    newfileName = this.folderFileInfo.folder + fileName;
						    console.log("newFileName",newfileName);
						} else {
							newfileName = this.folderFileInfo.folder + this.backsplash + fileName;
							console.log("newFileName",newfileName);
					    }

						if (type === 'folder') {
							fileProvider.createFolder(null, newfileName, function (result) {
								if (result.status === 'success') {
							        this.openFolder(this.folderFileInfo.folder);
							    } else {    
							        alert('Failed to create \"' + newfileName + '\"');
							    }
							}.bind(this));
						} else {
						    if (findTypeById(this.folderFileInfo.list,fileName) === '') {
							    fileProvider.createFile(null, newfileName, function (result) {
						            if (result.status === 'success') {
							            this.openFolder(this.folderFileInfo.folder);
							        } else {    
							            alert('Failed to create \"' + newfileName + '\"');
							        }	
					            }.bind(this));
							} else {
							   alert('\"' + newfileName + '\" already exist!');
							}
						}
				    }.bind(this));
				} else {
				    alert('Session time out! Failed to create Folder or File!');
				}
			};
			
			var renameFile = function (type,fileName) {
				if (fileName === '') {
				    alert('Invalid ' + type + ' name!!');
					return;
				}
				
			    if (this.sessionProvider.isAlive() === true) {
				    onionConsole.getService('onion-file-provider', function (err, fileProvider) {
					    this.fileProvider = fileProvider;
						if (type === 'folder') {
						    var newFoldername = fileProvider.getFolderPath(this.folderFileInfo.folder) + this.backsplash + fileName;
						    console.log("newFoldername",newFoldername);
							fileProvider.rename(null,this.folderFileInfo.folder,newFoldername, function (result) {
								if (result.status == 'success') {
								    var oldFoldername = this.folderFileInfo.folder;
								    this.folderFileInfo.folder = newFoldername;
							        this.openFolder(this.folderFileInfo.folder);
									alert('\"' + oldFoldername + '\" renamed to \"' + this.folderFileInfo.folder + '\" successfully!');
							    } else {    
							        alert('Failed to rename \"' + this.folderFileInfo.folder + '\"!');
							    }
							}.bind(this));
						} else {		
						    var newfileName = fileProvider.getFolderPath(this.folderFileInfo.fileInEdit) + this.backsplash + fileName;
						    console.log("newfileName",newfileName);
							fileProvider.rename(null,this.folderFileInfo.fileInEdit, newfileName, function (result) {
						        if (result.status == 'success') {
	                                var oldfileName = this.folderFileInfo.fileInEdit;
	                                console.log("oldfileName",oldfileName);								
							        this.folderFileInfo.fileInEdit = newfileName;
							        console.log("fileInEdit",this.folderFileInfo.fileInEdit);
							        var fileFolder = fileProvider.getFolderPath(oldfileName);
							        console.log("fileFolder",fileFolder);
									//if (this.folderFileInfo.folder === fileProvider.getFolderPath(oldfileName)) {
							            this.openFolder(this.folderFileInfo.folder);
									//}
								    alert('\"' + oldfileName + '\" renamed to \"' + this.folderFileInfo.fileInEdit + '\" successfully!');
							    } else {
							        alert('Failed to rename \"' + this.folderFileInfo.fileInEdit + '\"!');
							    }
					        }.bind(this));
						}
				    }.bind(this));
				} else {
				    alert('Session time out! Failed to create Folder or File!');
				}
			};

			var contextButtonManager = function(){
				console.log("contextButtonObserver is called");
				// if(this.$.saveFileButton && this.$.closeFileButton && this.$.renameFileButton && this.$.deleteFileButton){
				// 	if(this.folderFileInfo.fileInEdit == ''){
				// 		console.log("fileInEdit == ''");
				// 		// Means no file has been selected, disable the save,close,renamefile and deleteFile Buttons
				// 		this.$.saveFileButton.disabled=true;
				// 		this.$.closeFileButton.disabled=true;
				// 		this.$.renameFileButton.disabled=true;
				// 		this.$.deleteFileButton.disabled=true;
				// 		this.$.saveFileButton.opacity=.5;
				// 		this.$.closeFileButton.opacity=.5;
				// 		this.$.renameFileButton.opacity=.5;
				// 		this.$.deleteFileButton.opacity=.5;
				// 	} else if(this.folderFileInfo.fileInEdit != ''){
				// 		console.log("fileInEdit != ''");
				// 		this.$.saveFileButton.disabled=false;
				// 		this.$.closeFileButton.disabled=false;
				// 		this.$.renameFileButton.disabled=false;
				// 		this.$.deleteFileButton.disabled=false;
				// 	}
				// }
			};

			var fileChangeObserver = function(){
				console.log("!!!!!!!!!!!!!!!!!!!!FileChangeObserver gets called");
				console.log(this.folderFileInfo.file);
			};
			
			Polymer({
				is: 'onion-editor',
				created: created,
				ready: ready,
				behaviors: [Onion.AppBehavior],
				getLang: getLang,
				openFolder: openFolder,
				submitUpload: submitUpload,
				openFile: openFile,
				deleteFile: deleteFile,
				createFile: createFile,
				closeFile: closeFile,
				saveFile: saveFile,
				launchUploadFile: launchUploadFile,
				renameFile: renameFile,
				isFileChanged: isFileChanged,
				findTypeById: findTypeById,
				getFileExtension: getFileExtension,
				newFolderDialog: newFolderDialog,
				newFileDialog: newFileDialog,
				deleteFileDialog: deleteFileDialog,
				deleteFolderDialog: deleteFolderDialog,
				renameFileDialog: renameFileDialog,
				renameFolderDialog: renameFolderDialog,
				showLoadingScreen: showLoadingScreen,
				hideLoadingScreen: hideLoadingScreen,
				fileChangeObserver: fileChangeObserver,
				hideFileButtons: hideFileButtons,
				showFileButtons: showFileButtons,
				observers:['fileChangeObserver(folderFileInfo.file)'],
				properties:{
					files:{
						type:Array,
						value:[],
						notify:true
					},
					folderFileInfo:{
						type:Object,
						value:{},
						// 	folder:'/',
						// 	file: '',
						// 	list: null,
						// 	fileInEdit: ''
						// },
						notify:true
					},
					oldFilePath:{
						type: String,
						value:"",
						notify: true
					}
				}
			});
        })();
	</script>
</dom-module>
