<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/lib/juicy-ace-editor/src/juicy-ace-editor.html">
<link rel="import" href="/lib/iron-icons/iron-icons.html">
<link rel="import" href="/elements/onion-app/onion-app.html">
<link rel="import" href="/lib/Onion-Console/bootstrap-modal/bootstrap-modal.html">
<link rel="import" href="/elements/onion-file-list/onion-file-list.html">
<link rel="import" href="/elements/onion-loading/onion-loading.html">
<link rel="import" href="/elements/bootstrap-modal/bootstrap-modal.html">
<link rel="import" href="/elements/bootstrap-pills/bootstrap-pills.html">
<link rel="import" href="../../lib/polymer/polymer.html">
<link rel="import" href="../../lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../lib/juicy-ace-editor/src/juicy-ace-editor.html">
<link rel="import" href="../../lib/iron-icons/iron-icons.html">
<link rel="import" href="../../elements/onion-app/onion-app.html">
<link rel="import" href="../../lib/Onion-Console/bootstrap-modal/bootstrap-modal.html">
<link rel="import" href="../../elements/onion-file-list/onion-file-list.html">
<link rel="import" href="../../elements/onion-loading/onion-loading.html">
<link rel="import" href="../../elements/bootstrap-modal/bootstrap-modal.html">
<dom-module id="onion-editor">
	<style>
		:host {
		    display: block;
	  	    height: 100%;
			width: 100%;
			--bootstrap-pill-border-radius: 3px;
			--bootstrap-pill-color: #373a3c;
		}

		onion-app-body > div {
			height: 100%;
			width: 100%;
		}

		#side-bar {
			width: 300px;
			height: 100%;
			position: relative;
		}

/*			#current-folder {
				font-size: 13px;
				position: absolute;
				top: 0;
				width: 100%;
			    color: black;
			    background-color: #bdc3c7;
				font-family: monospace;
				padding: 10px;
	            line-height: 20px;
	            z-index: 10;
			}*/

			onion-file-list {
				width: 100%;
				height: 100%;
				padding-top: 20px;
				background-color: #ecf0f1;
			}

		#editor-container {
		    width: 100%;
			height: 100%;
			background-color:#373a3c;
		}

	    #fileEditor {
	        width: 100%;
	        height: 100%;
	    }
		#toast1 {
		    margin-left:20%;
		}
		.horizontal-section {
			padding: 0 !important;
        }
		paper-item {
			--paper-item: {
				cursor: pointer;
			};
		}

		onion-app-toolbar button {
			padding: 0 10px;
			background-color: transparent;
		}
		onion-app-toolbar button:hover {
			background-color: rgba(255, 255, 255, 0.5);
		}
		onion-app-toolbar button > iron-icon {
			margin-right: 5px;
		}

		:host ::content .ace_search_field {
			color: #333!important;
		}
	</style>
	<template>
		<onion-app app-name="Editor" toolbar-background="#34495e" toolbar-color="#fff">
			<onion-app-toolbar page-id="home">
				<div class="layout horizontal">
					<div class="flex">
						<button on-click="launchUploadFile" id="uploadFileButton"><iron-icon class="toolbar-icon" icon="icons:folder"></iron-icon><span>Upload File</span></button>
						<button on-click="newFolderDialog"><iron-icon class="toolbar-icon" id="newFolderButton" icon="icons:folder"></iron-icon><span>New Folder</span></button>
						<button on-click="newFileDialog"><iron-icon class="toolbar-icon" id="newFileButton" icon="icons:note-add"></iron-icon><span>New File</span></button>
						<button on-click="deleteFolderDialog" disabled="disabled" id="deleteFolderButton"><iron-icon class="toolbar-icon" icon="icons:delete"></iron-icon><span>Delete Folder</span></button>
						<button on-click="deleteFileDialog" disabled="disabled" id="deleteFileButton"><iron-icon class="toolbar-icon" icon="icons:delete"></iron-icon></span><span>Delete File</span></button>
						<button on-click="renameFolderDialog" disabled="disabled" id="renameFolderButton"><iron-icon class="toolbar-icon" icon="icons:create"></iron-icon></span><span>Rename Folder</span></button>
					    <button on-click="renameFileDialog" disabled="disabled" id="renameFileButton"><iron-icon class="toolbar-icon" icon="icons:create"></iron-icon></span><span>Rename File</span></button>
					</div>
					<div>
						<button id="saveFileButton" on-click="saveFile"><iron-icon class="toolbar-icon" icon="icons:check"></iron-icon><span>Save</span></button>
						<button id="closeFileButton" on-click="closeFile"><iron-icon class="toolbar-icon" icon="icons:close"></iron-icon><span>Close</span></button>
					</div>
				</div>
			</onion-app-toolbar>

			<onion-app-body page-id="home">
				<div class="horizontal layout">
					<div id="side-bar">
<!-- 					    <div id="current-folder">{{currentFolder}}</div> -->
						<onion-file-list id="fileList" on-open="fileClick" files="{{files}}" current-folder="{{currentFolder}}">No File</onion-file-list>
					</div>
					<div id="editor-container" class="flex vertical-layout-center-center">
						<bootstrap-modal id="fileUploadDialog" title="Upload A File!">
							<modal-body>
								<form action="/cgi-bin/cgi-upload" method="post" enctype="multipart/form-data">
									<input id="fileSelectionInput" type="file" name="file"></input>
									<input id="fileSelectionButton" type="submit" name="Submit" value="Submit Form">Upload!</input>
								</form>
							</modal-body>
						</bootstrap-modal>
						<bootstrap-pills selected="{{currentTab}}">
							<template is="dom-repeat" items="{{openFiles}}">
								<bootstrap-pill>
									<span>[[item.fileName]]</span>
								</bootstrap-pill>
							</template>
						</bootstrap-pills>
					    <juicy-ace-editor id="fileEditor" theme="ace/theme/monokai" mode="ace/mode/text" fontsize="13px"></juicy-ace-editor>
					</div>
				</div>
			</onion-app-body>
		</onion-app>	
	</template>
	<script>
		'use strict';
		(function () {
			// var this = null;

			var created = function () {
				// this = this;
			};

			var submitUpload = function(){
				// console.log(this.$.fileSelectionInput.value);
			};

			var backsplash = null;
			var extSymbol = null;

			var launchUploadFile = function(){
				this.$.fileUploadDialog.open();
			};

			var hideFileButtons = function(){
				this.$.saveFileButton.disabled=true;
				this.$.closeFileButton.disabled=true;
				this.$.renameFileButton.disabled=true;
				this.$.deleteFileButton.disabled=true;
				this.$.saveFileButton.hidden=true;
				this.$.closeFileButton.hidden=true;
				this.$.renameFileButton.hidden=true;
				this.$.deleteFileButton.hidden=true;
			};

			var showFileButtons = function(){
				this.$.saveFileButton.disabled=false;
				this.$.closeFileButton.disabled=false;
				this.$.renameFileButton.disabled=false;
				this.$.deleteFileButton.disabled=false;
				this.$.saveFileButton.hidden=false;
				this.$.closeFileButton.hidden=false;
				this.$.renameFileButton.hidden=false;
				this.$.deleteFileButton.hidden=false;
			};

			var fileClick = function(e){
				console.log("fileEventClick",e.detail);
				var fileObj  = e.detail;
				fileObj.fileName = fileObj.name;
				if(this.isFile(fileObj)){
					this.openFile(fileObj);
				}else{
					this.openFolder(fileObj);
				}
			};

			var openFile = function(fileObj){
				//Is fileObj in the openFile Array 
				if(this.isFileInArray(fileObj,this.openFiles)){
					//Modify the fileName attribute
					// fileObj.fileName = fileObj.absolutePath;
					//Bring it to the forefront
					this.getfileIndex(fileObj,function(index){
						console.log(index);
						this.currentTab = index;
					}.bind(this));
				} else{
					//Do need to add it. 
					this.addFileToArray(fileObj,function(){
						//And also Bring it to the forefront
						this.getfileIndex(fileObj,function(index){
							console.log(index);
							this.currentTab = index;
							console.log(this.currentTab);
						}.bind(this));
					}.bind(this));
				}
			};


			var addFileToArray = function(fileObj,callback){
				this.getFileCode(fileObj.absolutePath,function(code){
					console.log(code);
					fileObj.code = code;
					fileObj.selected = true;
					fileObj.bSave = true;
					fileObj.language = this.getLang(fileObj.name);
					this.push('openFiles',fileObj);
					callback();
				}.bind(this));
				//return the last index of the array
			};

			var getfileIndex = function(fileObj,callback){
				var ind = this.openFiles.forEach(function(element,index){
					if(fileObj.absolutePath == element.absolutePath){
						callback(index);
					}
				});
			};

			var getFileCode = function(filePath,callback){
				this.fileProvider.getFile(null,filePath,function (response){
					if(response.status == 'success'){
						var code = response.data;
						callback(code);
					} else{
						//Error For Unable to Open the 
						//Maybe open a modal here;
					}
				});
			};

			var isFileInArray = function(obj,array){
				var length = array.length;
				var ind = length - 1;
				var bPress = false;
				array.forEach(function(element,index){
					if(obj.absolutePath == element.absolutePath){
						bPress = true;
					}
					if(ind == index){
						return bPress;
					}
				});
			};

			var isFile = function(fileObj){
				if(fileObj.type == 'directory'){
					return false;
				}else{
					return true;
				}
			};

			var ready = function () {
				this.backsplash = '/';
				this.extSymbol = '.';
				this.fileName = '';
				
				this.folderFileInfo = {
					folder: this.backsplash, //current folder
					file: '',           //current file
					list: null,         
					fileInEdit: ''      //current folder + current file
				};
				onionConsole.getService('onion-session-provider', function (err, sessionProvider) {
					this.sessionProvider = sessionProvider;
					if (sessionProvider.isAlive() === true) {   
						onionConsole.getService('onion-file-provider', function (err, fileProvider) {
							this.fileProvider = fileProvider;
							this.openFolder({absolutePath:this.currentFolder});
						}.bind(this));
					}
				}.bind(this));	
			};

			var loadOpenFile = function(openFileArray,fileIndex){
				console.log("The File Index is",fileIndex);
				openFileArray.forEach(function(element,index){
					if(index == fileIndex){
						console.log("Index",index);
						console.log("Element",element);
						this.$.fileEditor.editor.session.setMode('ace/mode/' + element.language);
						this.$.fileEditor.editor.session.setValue(element.code);
						return;
					}
				}.bind(this));
			};
			 
			var findTypeById = function (sourceList, name) {
			    var result = '';

				if (sourceList !== null) {
				    for (var i = 0; i < sourceList.length; i++) {
					    if (sourceList[i].name === name) {
					        result = sourceList[i].type;
					    }
				    }
				}

				return result;
			};
			 
			var isFileChanged = function () {
			    var changed = false;
			    if (this.folderFileInfo.fileInEdit !== '' &&	this.currentCode !== this.$.fileEditor.editor.session.getValue()) {
				    changed = true;
				}

				return changed;
			};
			
			//Keep This Function
			var getFileExtension = function (fileString) {
			    return fileString.substring(fileString.lastIndexOf('.') + 1, fileString.length);
			};

			var getLang = function(fileName){
				console.log(fileName);
				var extension = this.getFileExtension(fileName);
				console.log(extension);
				if(extension == 'js'){
					return 'javascript';
				} else if(extension == 'py'){
					return 'python';
				} else if(extension == 'html'){
					return 'html';
				} else{
					return 'txt';
				}
			}
			
			var openFolder = function (folderObj) {
				var currentFile = '';
                if (this.sessionProvider.isAlive() === true) {
					var changed = true;
					console.log("Inside the openFolder Function");
					this.fileProvider.getFolderContent(null,folderObj.absolutePath, function(result){
						if(result.status == 'success'){
							console.log(result);
							this.files =result.list;
							this.currentFolder = folderObj.absolutePath;
						}else{
							//Handle error, maybe open a modal
						}
					}.bind(this));
				}
			};
			
			var closeFile = function (callback) {

				this.$.fileEditor.editor.session.setValue('');
			};
			
			var saveFile = function (callback) {
			    //var saveResult=true;
				if (this.sessionProvider.isAlive() === true) {	

				}
				//return saveResult;
			};
			
			var newFolderDialog = function () {
				var folderName = prompt('Please enter new folder name');
				
				if (folderName !== null) {
				    this.createFile('folder', folderName);
				}
			};
			
			var newFileDialog = function () {
				var fileName = prompt('Please enter new file name');

				if (fileName !== null) {
				    this.createFile('file', fileName);
				}
			};
			
			var deleteFileDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.fileInEdit !== '') {	
                    if (confirm('Are you sure that you want to permanently delete \"' + this.folderFileInfo.fileInEdit + '\" ?')) {
                    	console.log(this.folderFileInfo.fileInEdit);
                        this.deleteFile('file', this.folderFileInfo.fileInEdit);			  
					}	   
			    }
			};
			
			var deleteFolderDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.folder) {
                    if (this.folderFileInfo.folder === this.backsplash) {
                        alert('Delete all folders and files under root directory will make the system no long in function! Operation aborted!!'); 
                    } else {
                        if (confirm('Are you sure that you want to permanently delete \"' + this.folderFileInfo.folder + '\" folder?\nWarning!! All the folders and files under \"' + this.folderFileInfo.folder + '\" will be deleted!')) {
                        	console.log("folderFileInfo.folder",this.folderFileInfo.folder);
                            this.deleteFile('folder', this.folderFileInfo.folder);					   
                        }
					}	   
			    }
			};
			
			var renameFileDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.fileInEdit !== '') {	
				    var fileName = prompt('Please enter new file name');
					if (fileName !== null) {
                        this.renameFile('file', fileName);			  	   
					}
			    }
			};
			
			var renameFolderDialog = function () {
                if (this.sessionProvider.isAlive() === true && this.folderFileInfo.folder !== this.backsplash) {	
				    var folderName = prompt('Please enter new folder name');
					if (folderName !== null) {
                        this.renameFile('folder', folderName);		
                    }						
			    }
			};
						
			var deleteFile = function (type, fileName) {
				console.log("fileName",fileName);
			   if (this.sessionProvider.isAlive() === true ) {
				} else {
				    alert('Session time out! Failed to delete Folder or File!');
				}
			};
			
			var createFile = function (type, fileName) {
			    if (fileName === '') {
				    alert('Invalid ' + type + ' name!!');
					return;
				}
			    if (this.sessionProvider.isAlive() === true ) {

				} else {
				    alert('Session time out! Failed to create Folder or File!');
				}
			};
			
			var renameFile = function (type,fileName) {
				if (fileName === '') {
				    alert('Invalid ' + type + ' name!!');
					return;
				}
				
			    if (this.sessionProvider.isAlive() === true) {

				} else {
				    alert('Session time out! Failed to create Folder or File!');
				}
			};



			var saveUpdate = function(ind){
				var currentCode = this.openFiles.forEach(function(element,index){
					if(index == ind){
						currentCode = this.$.fileEditor.editor.session.getValue();
						return currentCode;
					}
				}.bind(this));
				if(currentCode == this.openFiles[ind].code){
					console.log("The codes are the same and do not need to be saved");
					this.openFiles[ind].bSave = false;
				}else{
					console.log("The codes are not the same and a save is necessary")
					this.openFolder[ind].bSave = true;
					this.openFiles[ind].code = currentCode;
				}
			};

			var currentTabChange = function(){
				console.log("Current Tab observer has been called");
				console.log(this);
				console.log("currentTab",this.currentTab);
				console.log("openFiles",this.openFiles);
				this.saveUpdate(this.fileIndex);
				this.loadOpenFile(this.openFiles,this.currentTab);
				this.fileIndex = this.currentTab;
			};

			var openFilesObserver = function(){
				console.log("openFilesObserver gets called");
				// var dummyObj = {fileName = "",
				// 				name = "",
				// 				code = "",
				// 				bSave = false,
				// 				selected = true,	
				// 				language = "",
				// 				absolutePath = ""};
				// if( this.openFiles == []){
				// 	this.push('openFiles',dummyObj);
				// 	this.currentTab = 0;
				// }
			}
			
			Polymer({
				is: 'onion-editor',
				created: created,
				ready: ready,
				behaviors: [Onion.AppBehavior],
				getLang: getLang,
				openFolder: openFolder,
				submitUpload: submitUpload,
				openFile: openFile,
				deleteFile: deleteFile,
				createFile: createFile,
				closeFile: closeFile,
				saveFile: saveFile,
				launchUploadFile: launchUploadFile,
				renameFile: renameFile,
				isFileChanged: isFileChanged,
				findTypeById: findTypeById,
				getFileExtension: getFileExtension,
				newFolderDialog: newFolderDialog,
				newFileDialog: newFileDialog,
				deleteFileDialog: deleteFileDialog,
				deleteFolderDialog: deleteFolderDialog,
				renameFileDialog: renameFileDialog,
				renameFolderDialog: renameFolderDialog,
				hideFileButtons: hideFileButtons,
				showFileButtons: showFileButtons,
				currentTabChange: currentTabChange,
				loadOpenFile: loadOpenFile,
				fileClick: fileClick,
				addFileToArray: addFileToArray,
				isFile: isFile,
				getFileCode:getFileCode,
				getfileIndex: getfileIndex,
				openFilesObserver:openFilesObserver,
				isFileInArray: isFileInArray,
				saveUpdate: saveUpdate,
				properties:{
					files:{
						type:Array,
						value:[],
						notify:true
					},
					folderFileInfo:{
						type:Object,
						value:{},
						// 	folder:'/',
						// 	file: '',
						// 	list: null,
						// 	fileInEdit: ''
						// },
						notify:true
					},
					currentFolder:{
						type: String,
						value: '/',
						notify: true
					},
					openFiles:{
						type: Array,
						value: [],
						notify: true,
						observer: 'openFilesObserver'
					},
					oldFilePath:{
						type: String,
						value:"",
						notify: true
					},
					currentTab:{
						type:Number,
						value:null,
						notify:true,
						observer: 'currentTabChange'
					},
					fileIndex:{
						type:Number,
						value:null,
						notify:true
					}
				}
			});
        })();
	</script>
</dom-module>
