<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-icons/iron-icons.html">

<dom-module id="onion-settings-ap">
	<style>
		body {
			background-color: #f2f2f2;
			padding-top: 4rem;
			padding-bottom: 4rem;
		}

		.main {
			background-color: #fff;
			border-color: transparent;
			padding: 4rem 2rem;
			margin-bottom: 0;
		}

		.container {
			width: 600px;
			margin: 0 auto;
		}

		.card {
			margin-top: 15px;
			background-color: #fff;
		}
			.card form > .form-group:last-child {
				margin-bottom: 0;
			}
	</style>

	<template>
		<div class="container">
			<h4 class="card-title">Wi-Fi Access Point Setup</h4>
			<div class="card card-block">
				<form id="ap-form">
					<div class="form-group row">
						<!-- ssid -->
						<label for="ap-ssid" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">AP Network (SSID)</label>
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
							<input type="text" class="form-control" id="apSsid" autocomplete="off" value="{{networkSsid::input}}" />
						</div>
					</div>
					<div class="form-group row">
						<!-- encryption select -->
						<label for="ap-encryption" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Security</label>
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
							<select class="form-control c-select" id="apEncryption" autocomplete="off" value="{{networkAuth::input}}">
								<option value="none" selected>None</option>
								<option value="wep">WEP</option>
								<option value="psk">WPA</option>
								<option value="psk2">WPA2</option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<!-- password -->
						<label for="ap-key" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">AP Password</label>
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
							<input type="password" class="form-control" id="apKey" autocomplete="off" value="{{networkPassword::input}}" />
						</div>
					</div>

					<div class="row">
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
							<div id="ap-message">{{apMessage}}</div>
						</div>
					</div>

					<div class="form-group row">
						<!-- start ap-config -->
						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
						<button id="ap-config-button" type="button" class="btn btn-success btn-block" on-click="setupAP">Configure AP</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			var self = null;

			var created = function () {
				self = this;
			};
			
			var ready = function () {				
				onionConsole.getService('onion-session-provider', function (sessionProvider) {
                    self.sessionProvider = sessionProvider;
                });
				
                if (self.sessionProvider.isAlive() === true) {
                    onionConsole.getService('onion-wifi-provider', function (wifiProvider) {
                        self.wifiProvider = wifiProvider;
					});
                };
			};

			var init = function () {
				var wifiConfigPromise = self.wifiProvider.getConfig('ap');

                wifiConfigPromise.then(function (result) {
                	self.set('networkSsid', result.ssid);
                	self.set('networkAuth', result.encryption);
                	self.set('networkPassword', result.password);
                });
			};

			var onAppIcon = function (e) {
				self.onionConsole.launchApp(e.target);
			};

			var setupAP = function () {
			    self.apMessage = ''; 

				var verifyResult = self.wifiProvider.verifyKey(self.$.apKey.value, self.$.apEncryption.value);
				
				if (verifyResult === 'OK') {
			        if (self.sessionProvider.isAlive() === true) {   
				        self.wifiProvider.apSetup(self.$.apSsid.value, self.$.apKey.value, self.$.apEncryption.value, function (data) {
						    if (data.apSetup === false) {
						        self.apMessage = 'AP setup failed!'; 
						    } else {
						        self.apMessage = 'AP setup successfully!';
						    }
					    });
				    }
				} else {
				    self.apMessage = verifyResult;
				}
			}

			Polymer({
				is: 'onion-settings-ap',
				created: created,
				ready: ready,
				init: init,
				setupAP: setupAP,
				properties: {
					networkSsid: {
						type: String,
						notify: true
					},
					networkAuth: {
						type: String,
						notify: true
					},
					networkPassword: {
						type: String,
						notify: true
					},
					test: {
						type: String,
						notify: true,
						value: "test"
					},
				}
			});
		})();
	</script>
</dom-module>
