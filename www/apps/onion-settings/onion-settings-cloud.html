<link rel="import" href="../../lib/polymer/polymer.html">
<link rel="import" href="../../elements/bootstrap-alert/bootstrap-alert-container.html">

<dom-module id="onion-settings-cloud">
	<style>
		.container {
			width: 100%;
			margin: 0 auto;
		}
        
        #iframe-div
        {
            width    : auto;
            height   : 100vh;
            /*overflow : hidden;*/
            position : relative;
        }
         
        #iframe
        {
            position : absolute;
            /*left     : -350px;*/
        }
	</style>

	<template>

		<div class="container">
            <div id="iframe-div">
                <iframe id="iframe" src="https://registerdevice.onion.io" style="width:100%;height:100%;"></iframe>
            </div>
		</div>

	</template>

    <script>
		'use strict';

		(function() {
			var ready = function () {
				window.addEventListener("message", receiveMessage); //Listening for message from modal
			};
            
            var receiveMessage= function (result) {
                if (result.origin !== "https://registerdevice.onion.io")
	            return;
                
                var params = {
                    deviceId: result.data.content.deviceId,
                    secret: result.data.content.deviceSecret
                };
                
                // send UCI command
                var promise = new Promise(function (resolve, reject) {
					onionConsole.getService('onion-device-provider', function (err, deviceProvider) {
						this.deviceProvider = deviceProvider;
						// this.deviceProvider.callService(null,'uci', 'set', {
                        this.deviceProvider.callService(null,'uci', 'add', {
							config: 'onion',
							type: 'cloud',
							name: 'cloud'
						}, function (err,result) {
							console.log('uci add onion cloud result:', result);
							if (!err) {
                                this.deviceProvider.callService(null, 'uci', 'set', {
                                    config: 'onion',
                                    section: 'cloud',
                                    values: params
                                }, function (err, result) {
                                    if (!err) {
                                        this.deviceProvider.callService(null,'uci', 'commit', {
        									config: 'onion'
        								}, function (err, result) {
        									if (!err) {
                                                console.log('uci commit onion result: ', result);
                                                
                                                // restart the device client
                                                this.deviceProvider.callService(null, 'file', 'exec', {
                                                    command: '/etc/init.d/device-client',
                                                    params: ['restart']
                								}, function (err, result) {
                									if (!err) {
                                                        console.log('file exec result: ', result);
                                                        resolve();
                                                    }
                                                    else {
                                                        reject(Error('Unable to restart device client.'));
                                                    }
                                                }.bind(this));
        										
        									} else {
        										reject(Error('Unable to set Onion Cloud configuration.'));
        									}
        								}.bind(this));
                                    } else {
                                        reject(Error('Unable to set Onion Cloud configuration.'));
                                    }
                                }.bind(this));
							} else {
								reject(Error('Unable to set Onion Cloud configuration.'));
							}
						}.bind(this));
					}.bind(this));
				}.bind(this));
				return promise;
            };
			
			Polymer({
				is: 'onion-settings-cloud',
				ready: ready,
				properties: {
                    
				}
			});
		})();
	</script>
</dom-module>