<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/elements/bootstrap-alert/bootstrap-alert.html">

<dom-module id="onion-settings-update">
	<style>
		.container {
			width: 600px;
			margin: 0 auto;
		}

		.card {
			margin-top: 15px;
			background-color: #fff;
		}

		#upgradeButtonContainer {
			margin-bottom: 15px;
		}

		.loading{
			height: 20px;
			width: 20px;
			margin-left: 15px; 
			-webkit-animation: rotation 1s infinite linear;
			-moz-animation: rotation 1s infinite linear;
			-o-animation: rotation 1s infinite linear;
			animation: rotation 1s infinite linear;
			border-left: 3px solid #EAF1FF;
			border-right: 3px solid #EAF1FF;
			border-bottom: 3px solid #EAF1FF;
			border-top: 3px solid #2450AD;
			border-radius: 100%
		}

		@-webkit-keyframes rotation {
			from{
				-webkit-transform: rotate(0deg)
			}
			to{
				-webkit-transform: rotate(359deg)
			}
		}

		@-moz-keyframes rotation {
			from{
				-moz-transform: rotate(0deg)
			}
			to{
				-moz-transform: rotate(359deg)
			}
		}

		@-o-keyframes rotation {
			from{
				-o-transform: rotate(0deg)
			}
			to{
				-o-transform: rotate(359deg)
			}
		}

		@keyframes rotation {
			from{
				transform: rotate(0deg)
			}
			to{
				transform: rotate(359deg)
			}
		}
	</style>

	<template>

		<div class="container">
			<h4>Firmware Upgrade</h4>
			<div class="card card-block">
				<bootstrap-alert warning no-close>
					<h6>Attention!</h6>
					<p>Firmware upgrade will erase all files outside of the <code>/etc</code> directory. Please backup any custom files before proceeding.</p>
				</bootstrap-alert>

				<table class="table">
					<tbody>
						<tr>
							<th scope="row">Name</th>
							<td>{{name}}</td>
						</tr>
						<tr>
							<th scope="row">Model</th>
							<td>{{model}}</td>
						</tr>
						<tr>
							<th scope="row">Revision</th>
							<td>{{modelRev}}</td>
						</tr>
						<tr>
							<th scope="row">Firmware</th>
							<td>{{currentVersion}}</td>
						</tr>
					</tbody>
				</table>

				<div class="layout horizontal center" id="upgradeButtonContainer">
					<button class="btn btn-success" on-click="upgradeFirmware">Upgrade</button>
					<div id="upgradeLoading" class="loading" hidden></div>
				</div>

				<div id="upgradeAlerts"></div>
			</div>
		</div>


	</template>

	<script>
		'use strict';

		(function () {
			var ready = function () {
				this.model 		= 'Onion Omega';
				this.modelRev 	= 'R1';
				this.dataReady	= 0;
			};

			var init = function () {
				this.getFirmwareInfo();
				this.checkFirmwareInfo();
			};

			// use ubus to get the firmware info data
			var getFirmwareInfo = function () {
				var onionSettingUpdate 	= this;

				// get the ubus service
				onionConsole.getService('onion-ubus-provider', function (ubus) {
					var params = {
						params: {
							check: ''
						}
					};

					// do ubus oupgrade check
					ubus.request('onion', 'oupgrade', params, function (data) {
						if (data) {
							var returnCode = data[0];
							console.log('oupgrade check return code: ', returnCode);

							if (returnCode === 0) {
								onionSettingUpdate.data = data[1];
								console.log(onionSettingUpdate.data);	// get rid of this when app is done

								// denote that data has be received
								onionSettingUpdate.dataReady = 1;
							}
							else {
								console.log('oupgrade check error');
							}
						}
					});
				});
			};

			// make sense of the firmware info data
			var checkFirmwareInfo = function () {
				var onionSettingUpdate 	= this;

				var checkDataReadyInterval = setInterval(function () {
					if (onionSettingUpdate.dataReady === 1) {
						// stop the loop after this code
						clearInterval(checkDataReadyInterval);


						// current omega firmware:
						//	onionSettingUpdate.data.device.version
						//	onionSettingUpdate.data.device.major
						//	onionSettingUpdate.data.device.minor
						//	onionSettingUpdate.data.device.revision
						//	onionSettingUpdate.data.device.build

						onionSettingUpdate.data.device.string 	= onionSettingUpdate.data.device.version + " (b" + onionSettingUpdate.data.device.build + ")";
						onionSettingUpdate.currentVersion 		= onionSettingUpdate.data.device.string;
						

						// latest omega firmware:
						//	onionSettingUpdate.data.repo.version
						//	onionSettingUpdate.data.repo.major
						//	onionSettingUpdate.data.repo.minor
						//	onionSettingUpdate.data.repo.revision
						//	onionSettingUpdate.data.repo.build

						onionSettingUpdate.data.repo.string 	= onionSettingUpdate.data.repo.version + " (b" + onionSettingUpdate.data.repo.build + ")";
						onionSettingUpdate.latestVersion 		= onionSettingUpdate.data.repo.string;


						// info on binary file:
						//	binary name: 	onionSettingUpdate.data.image.binary
						//	path on Omega: 	onionSettingUpdate.data.image.local
						//	URL (not needed): 	onionSettingUpdate.data.image.url;


						// info on upgrade:
						//	onionSettingUpdate.data.upgrade
						//		true: 	upgrade required, version numbers do not match
						// 		false: 	upgrade not required, version numbers match
						// 	onionSettingUpdate.data.build_mismatch
						//		true: 	upgrade possible, version numbers match but build numbers do not
						// 		false: 	upgrade not required, version numbers AND build numbers match
						// upgrade table
						//	case	upgrade 	build_mismatch 	perform upgrade:
						//	1 		true 		false			yes - version number mismatch
						//	2 		false 		true			yes, but optional - build number mismatch
						// 	3		false		false			no  - same version and build numbers
						
					}
				}, 1000);
			};

			// use ubus to initiate the firmware upgrade
			var upgradeFirmware = function () {
				var onionSettingUpdate 	= this;
				console.log('calling oupgrade ubus service...');

				onionSettingUpdate.$.upgradeLoading.hidden = false;

				var alertElement = document.createElement('bootstrap-alert');
				alertElement.setAttribute('warning', true);
				Polymer.dom(alertElement).innerHTML = '<p>Firmware upgrade has started! Please be patient, this might take a little while. When the Omega has rebooted, the firmware upgrade will be complete.</p><p>Do NOT unplug the Omega during this process.</p>';

				Polymer.dom(onionSettingUpdate.$.upgradeAlerts).appendChild(alertElement);
				Polymer.dom.flush();

				// get the ubus service
				onionConsole.getService('onion-ubus-provider', function (ubus) {
					var params = {
						params: {
							force: ''
						}
					};

					// do ubus oupgrade
					ubus.request('onion', 'oupgrade', params, function (data) {
						if (data) {
							var returnCode = data[0];
							console.log('oupgrade return code: ', returnCode);

							if (returnCode === 0) {
								console.log('oupgrade started!');
							}
							else {
								console.log('oupgrade error');
							}
						}
					});
				});
			};

			Polymer({
				is: 'onion-settings-update',
				ready: ready,
				init: init,
				getFirmwareInfo: getFirmwareInfo,
				checkFirmwareInfo: checkFirmwareInfo,
				upgradeFirmware: upgradeFirmware,
				properties: {
					settings: Array
				}
			});
        })();
	</script>

</dom-module>
