<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-icons/iron-icons.html">

<dom-module id="onion-settings-wifi">
	<style>
		body {
			background-color: #f2f2f2;
			padding-top: 4rem;
			padding-bottom: 4rem;
		}

		.main {
			background-color: #fff;
			border-color: transparent;
			padding: 4rem 2rem;
			margin-bottom: 0;
		}

		.container {
			width: 600px;
			margin: 0 auto;
		}

		.card {
			margin-top: 15px;
			background-color: #fff;
		}
			.card form > .form-group:last-child {
				margin-bottom: 0;
			}
	</style>

	<template>
		<div class="container">
			<h4 class="card-title">Wi-Fi Network Setup</h4>
			<div class="card card-block">
				<form id="wifi-form">
					<div class="form-group row">
						<!-- Detected networks -->
						<label for="wifi-select" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Detected Networks</label>
						<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
							<select class="form-control c-select" id="wifi-select" autocomplete="off" on-change="selectSsid" selected=0>
								<!-- optional message on menu -->
								<template is="dom-if" if="{{wifiScanMsgEn}}">
									<option value="" disabled selected>{{wifiScanMsg}}</option>
								</template>
								<!-- list out the wifi networks -->
								<template is="dom-repeat" items="{{networks}}">
									<option value="{{index}}">{{item.ssid}}</option>
								</template>
							</select>
						</div>
						<!-- Scan Button -->
						<div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
							<button id="wifi-scan-btn" type="button" class="btn btn-block btn-primary" on-click="scanWifiNetwork">
								<iron-icon icon="icons:refresh"></iron-icon>
							</button>
						</div>
					</div>
					<div class="form-group row">
						<!-- ssid -->
						<label for="wifi-ssid" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Wi-Fi Network (SSID)</label>
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
							<input type="text" class="form-control" id="wifi-ssid" autocomplete="off" value="{{networkSsid::input}}"/>
						</div>
					</div>
					<div class="form-group row">
						<!-- encryption select -->
						<label for="wifi-encryption" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Security</label>
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
							<select class="form-control c-select" id="wifi-encryption" autocomplete="off" value="{{networkAuth::input}}">
								<option value="none" selected>None</option>
								<option value="wep">WEP</option>
								<option value="psk">WPA</option>
								<option value="psk2">WPA2</option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<!-- password -->
						<label for="wifi-key" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Wi-Fi Password</label>
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
							<input type="password" class="form-control" id="wifi-key" autocomplete="off" value="{{networkPassword::input}}"/>
						</div>
					</div>

					<div class="row">
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
							<div id="wifi-message">{{wifiMessage}}</div>
						</div>
					</div>

					<div class="form-group row">
						<!-- start wifi-config -->
						<div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
						<button id="wifi-config-button" type="button" class="btn btn-success btn-block" on-click="setupWifi">Configure Wi-Fi</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			var onionWifisetup = null;
			var ready = function () {
				onionWifisetup = this;
				onionWifisetup.networks 	= [];
				onionWifisetup.networkId	= -1;

				this.hideScanMessage();

				//this.scanWifiNetwork();
				
				onionConsole.getService("onion-session-provider", function (sessionProvider) {
                    onionWifisetup.sessionProvider = sessionProvider;
                });
				
                if(onionWifisetup.sessionProvider.isAlive()===true)
				{
                    onionConsole.getService("onion-wifi-provider", function (wifiProvider) {
                        onionWifisetup.wifiProvider=wifiProvider;
					});
                };
			};

			var onAppIcon = function (e) {
				this.onionConsole.launchApp(e.target);
			};

			var showScanMessage = function (message) {
				this.wifiScanMsgEn 	= true;
				this.wifiScanMsg 	= message;
			};

			var hideScanMessage = function() {
				this.wifiScanMsgEn 	= false;
				console.log("Hide scan message!");
			};

			var scanWifiNetwork = function() {
				onionWifisetup.showScanMessage("Scanning...");

				// get the ubus service
				onionConsole.getService('onion-ubus-provider', function (ubus) {
					var params = {
						device: 'wlan0'
					};

					// do ubus wifi-scan
					ubus.request('onion', 'wifi-scan', params, function (data) {
						if (data) {
							var returnCode = data[0];
							console.log("scan return code: ", returnCode);

							if (returnCode === 0) {
								//// successful scan
								// clear out old networks
								while (onionWifisetup.networks.length > 0) {
									onionWifisetup.pop('networks');
								}

								// add newly detected networks to array
								onionWifisetup.hideScanMessage();
								var detectedNetworks = data[1].results;
								for (let i = 0; i < detectedNetworks.length; i++) {
									onionWifisetup.push('networks', detectedNetworks[i] );
								}

								console.log("wifi-scan data:");
								console.log(onionWifisetup.networks);
							}
							else {
								console.log("scan error");
							}
						}
					});
				});
			};

			var selectSsid = function (event) {
				this.networkId = event.target.value;

				// find the selected network in the list
				var selectedNetwork = this.networks[this.networkId];
				console.log("Selected network: ");
				console.log(selectedNetwork);

				// find the ssid
				this.networkSsid = selectedNetwork.ssid;

				// translate the authentication type
				if (selectedNetwork.encryption === 'none') {
					this.networkAuth = "none";
				} else if (selectedNetwork.encryption.indexOf('WPA2') !== -1) {
					this.networkAuth = "psk2";
				} else if (selectedNetwork.encryption.indexOf('WPA') !== -1) {
					this.networkAuth = "psk";
				} else if (selectedNetwork.encryption.indexOf('WEP') !== -1) {
					this.networkAuth = "wep";
				}
				console.log("Auth: ", this.networkAuth);
			};
		
		    var setupWifi = function () {
			    onionWifisetup.wifiMessage="";
			    var verifyResult=onionWifisetup.wifiProvider.verifyKey(onionWifisetup.networkPassword, onionWifisetup.networkAuth);
				if(verifyResult=="OK") {
                    if(onionWifisetup.sessionProvider.isAlive()===true) {   
				        onionWifisetup.wifiProvider.wifiSetup(onionWifisetup.networkSsid, onionWifisetup.networkPassword, onionWifisetup.networkAuth, function (data) {
					        if(data.wifiSetup===false) {
						        onionWifisetup.wifiMessage="WiFi setup failed!";
						    } else {
						        onionWifisetup.wifiMessage="WiFi setup successfully!";
						    }
					    });
				    }
				} else {
				    onionWifisetup.wifiMessage=verifyResult;
				}
			}

			Polymer({
				is: 'onion-settings-wifi',
				ready: ready,
				showScanMessage: showScanMessage,
				hideScanMessage: hideScanMessage,
				scanWifiNetwork: scanWifiNetwork,
				selectSsid: selectSsid,
				setupWifi: setupWifi,
				// onDeviceIcon: onDeviceIcon
				properties: {
					networks: {
						type: Array,
						notify: true
					},
					networkSsid: {
						type: String,
						notify: true
					},
					networkAuth: {
						type: String,
						notify: true
					},
					networkPassword: {
						type: String,
						notify: true
					},
					test: {
						type: String,
						notify: true,
						value: "test"
					},
				}
			});
		})();
	</script>
</dom-module>
