<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/lib/iron-icons/iron-icons.html">

<link rel="import" href="/elements/bootstrap-modal/bootstrap-modal.html">
<link rel="import" href="/elements/bootstrap-button/bootstrap-button.html">

<dom-module id="onion-settings-wifi">
	<style>
		.main {
			background-color: #fff;
			border-color: transparent;
			padding: 4rem 2rem;
			margin-bottom: 0;
		}

		.container {
			width: 600px;
			margin: 0 auto;
		}

		.card {
			margin-top: 15px;
			background-color: #fff;
		}
			.card form > .form-group:last-child {
				margin-bottom: 0;
			}

		.loading{
			height: 20px;
			width: 20px;
			margin-left: 15px; 
			-webkit-animation: rotation 1s infinite linear;
			-moz-animation: rotation 1s infinite linear;
			-o-animation: rotation 1s infinite linear;
			animation: rotation 1s infinite linear;
			border-left: 3px solid #EAF1FF;
			border-right: 3px solid #EAF1FF;
			border-bottom: 3px solid #EAF1FF;
			border-top: 3px solid #2450AD;
			border-radius: 100%
		}

		@-webkit-keyframes rotation {
			from{
				-webkit-transform: rotate(0deg)
			}
			to{
				-webkit-transform: rotate(359deg)
			}
		}

		@-moz-keyframes rotation {
			from{
				-moz-transform: rotate(0deg)
			}
			to{
				-moz-transform: rotate(359deg)
			}
		}

		@-o-keyframes rotation {
			from{
				-o-transform: rotate(0deg)
			}
			to{
				-o-transform: rotate(359deg)
			}
		}

		@keyframes rotation {
			from{
				transform: rotate(0deg)
			}
			to{
				transform: rotate(359deg)
			}
		}
	</style>

	<template>

		<bootstrap-modal id="newWifiDlg" title="New WiFi Network">
			<modal-body>
				<form id="wifi-form">
					<fieldset disabled="{{!enableWifi}}">
						<div class="form-group row">
							<!-- Detected networks -->
							<label for="wifi-select" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Detected Networks</label>
							<div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
								<select class="form-control c-select" id="wifi-select" autocomplete="off" on-change="selectSsid" selected=0>
									<!-- optional message on menu -->
									<template is="dom-if" if="{{wifiScanMsgEn}}">
										<option value="" disabled selected>{{wifiScanMsg}}</option>
									</template>
									<!-- list out the wifi networks -->
									<template is="dom-repeat" items="{{networks}}">
										<option value="{{index}}">{{item.ssid}}</option>
									</template>
								</select>
							</div>
							<!-- Scan Button -->
							<div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
								<button id="wifi-scan-btn" type="button" class="btn btn-block btn-primary" on-click="scanWifiNetwork">
									<iron-icon icon="icons:refresh"></iron-icon>
								</button>
							</div>
						</div>
						<div class="form-group row">
							<!-- ssid -->
							<label for="wifi-ssid" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Wi-Fi Network (SSID)</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="wifi-ssid" autocomplete="off" value="{{networkSsid::input}}"/>
							</div>
						</div>
						<div class="form-group row">
							<!-- encryption select -->
							<label for="wifi-encryption" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Security</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<select class="form-control c-select" id="wifi-encryption" autocomplete="off" value="{{networkAuth::input}}">
									<option value="none" selected>None</option>
									<option value="wep">WEP</option>
									<option value="psk">WPA</option>
									<option value="psk2">WPA2</option>
								</select>
							</div>
						</div>
						<div class="form-group row">
							<!-- password -->
							<label for="wifi-key" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Wi-Fi Password</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type$="[[_computeShowPassword(showPassword)]]" class="form-control" id="wifi-key" autocomplete="off" value="{{networkPassword::input}}"/>
							</div>
						</div>
						<div class="form-group row">
							<!-- show password -->
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
								<input type="checkbox" id="showPassword" checked="{{showPassword::change}}" autocomplete="off" />&nbsp;<label for="showPassword">Show Password</label>
							</div>
						</div>

						<div class="row">
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
								<div id="wifi-message">{{wifiMessage}}</div>
							</div>
						</div>
					</fieldset>
				</form>
			</modal-body>
			<modal-footer>
				<bootstrap-button id="wifi-config-button" on-click="setupWifi" color-scheme="success">Add Network</bootstrap-button>
				<div id="configureLoading" class="loading" hidden></div>
			</modal-footer>
		</bootstrap-modal>

		<div class="container">
			<div class="card card-block">
				<div class="form-group row">
					<!-- enabled -->
					<label for="enableWifi" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Enable Wi-Fi</label>
					<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
						<div class="checkbox">
							<label><input type="checkbox" id="enableWifi" checked="{{enableWifi::change}}" autocomplete="off" /></label>
						</div>
					</div>
				</div>

				<!-- <bootstrap-button on-click="" color-scheme="success">Apply Setting</bootstrap-button> -->
				<bootstrap-button on-click="newWifiNetwork" color-scheme="prime">Add Wi-Fi Network</bootstrap-button>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			var self = null;

			var created = function () {
				self = this;
			};

			var attached = function () {
				self.networks 	= [];
				self.networkId	= -1;

				self.hideScanMessage();
				
				onionConsole.getService('onion-session-provider', function (sessionProvider) {
                    self.sessionProvider = sessionProvider;
                });
				
                if (self.sessionProvider.isAlive() === true) {
                    onionConsole.getService('onion-wifi-provider', function (wifiProvider) {
                        self.wifiProvider = wifiProvider;
					});
                };
			};

			var init = function () {
				self.scanWifiNetwork();

				var wifiConfigPromise = self.wifiProvider.getConfig('sta');

                wifiConfigPromise.then(function (result) {
                	self.set('enableWifi', result.enabled);
                	self.set('networkSsid', result.ssid);
                	self.set('networkAuth', result.encryption);
                	self.set('networkPassword', result.password);
                });



                var getWifiSetupPromise = self.wifiProvider.getWirelessSetup(false);
                getWifiSetupPromise.then(function(result){
                	console.log(result);
                });

			};

			var showScanMessage = function (message) {
				self.set('wifiScanMsgEn', true);
				self.wifiScanMsg = message;
			};

			var hideScanMessage = function () {
				self.set('wifiScanMsgEn', false);
				console.log('Hide scan message!');
			};

			var scanWifiNetwork = function () {
				self.showScanMessage('Scanning...');

				var wifiScanPromise = self.wifiProvider.wifiScan();

				wifiScanPromise.then(function (result) {
					while (self.networks.length > 0) {
						self.pop('networks');
					}

					// add newly detected networks to array
					self.showScanMessage('Select Wi-Fi Network:');

					var detectedNetworks = result.results;

					for (var i = 0; i < detectedNetworks.length; i++) {
						if (detectedNetworks[i].ssid !== '') {
							self.push('networks', detectedNetworks[i]);
						}
					}
				}, function (result) {
					console.error(result);
				});
			};

			var selectSsid = function (event) {
				self.networkId = event.target.value;

				// find the selected network in the list
				var selectedNetwork = self.networks[self.networkId];
				console.log('Selected network: ');
				console.log(selectedNetwork);

				// find the ssid
				self.networkSsid = selectedNetwork.ssid;

				// translate the authentication type
				if (selectedNetwork.encryption === 'none') {
					self.networkAuth = 'none';
				} else if (selectedNetwork.encryption.indexOf('WPA2') !== -1) {
					self.networkAuth = 'psk2';
				} else if (selectedNetwork.encryption.indexOf('WPA') !== -1) {
					self.networkAuth = 'psk';
				} else if (selectedNetwork.encryption.indexOf('WEP') !== -1) {
					self.networkAuth = 'wep';
				}

				console.log('Auth: ', self.networkAuth);
			};
		
		    var setupWifi = function () {
		    	self.$.configureLoading.hidden = false;
		    	self.$['wifi-config-button'].disabled = true;

		    	setTimeout(function () {
		    		self.$.configureLoading.hidden = true;
		    		self.$['wifi-config-button'].disabled = false;
		    	}, 10000);

			    self.wifiMessage = '';

			    var verifyResult = self.wifiProvider.verifyKey(self.networkPassword, self.networkAuth);

				if (verifyResult === 'OK') {
                    if (self.sessionProvider.isAlive() === true) {
                    	//var wifiSetupPromise = self.wifiProvider.wifiSetup(self.enableWifi, self.networkSsid, self.networkPassword, self.networkAuth, self.networkIp, self.networkNetmask);

                    	// add a network wifi-iface
                    	var wifiAddNetworkPromise = self.wifiProvider.prepareWifiNetwork();

                    	wifiAddNetworkPromise.then(function() {
                    		// setup the network
	                    	var wifiSetupPromise = self.wifiProvider.addWifiNetwork(self.networkSsid, self.networkPassword, self.networkAuth);

	                    	wifiSetupPromise.then(function () {

	                    	}, function (err) {
	                    		console.error(err);
	                    	});
                    	});
				    }
				} else {
				    self.wifiMessage = verifyResult;
				}
			};

			var _computeShowPassword = function (showPassword) {
				return showPassword ? 'text' : 'password';
			};

			var newWifiNetwork = function () {
				this.$.newWifiDlg.open();
			}

			Polymer({
				is: 'onion-settings-wifi',
				created: created,
				attached: attached,
				init: init,
				showScanMessage: showScanMessage,
				hideScanMessage: hideScanMessage,
				scanWifiNetwork: scanWifiNetwork,
				selectSsid: selectSsid,
				setupWifi: setupWifi,
				_computeShowPassword: _computeShowPassword,
				newWifiNetwork: newWifiNetwork,
				properties: {
					enableWifi: {
						type: Boolean,
						notify: true
					},
					networks: {
						type: Array,
						notify: true
					},
					networkSsid: {
						type: String,
						notify: true
					},
					networkAuth: {
						type: String,
						notify: true
					},
					networkPassword: {
						type: String,
						notify: true
					},
					showPassword: {
		    			notify: true,
				        type: Boolean,
				        value: false
		    		}
				}
			});
		})();
	</script>
</dom-module>
