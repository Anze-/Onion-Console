<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/elements/onion-app/onion-app.html">

<dom-module id="onion-gpio">
	<style>
	    :host {
			display: block;
			height: 100%;
			width: 100%;
		}

		onion-app-body > div {
			height: 100%;
			width: 100%;
			overflow: scroll;
			padding: 15px;
		}

		#pin-map {
			height: 600px;
			width: auto;
		}

		button.pin {
			border-radius: 5px;
			display: block;
			border: 1px solid #f2f2f2;
			font-size: 12px;
			padding: 3px 5px;
			background-color: #7f8c8d;
			color: #fff;

		}

		button.pin.gpio {
			background-color: #2ecc71;
		}

		#left-pins {
			margin-right: 10px;
		}

		#right-pins {
			margin-left: 10px;
		}

		#gpio-control {
			height: 415px;
			width: 300px;
			background: #fff;
			border-radius: 5px;
			margin-left: 25px;
			padding: 25px;
		}
			#gpio-pin-number {
				text-align: center;
				margin-bottom: 25px;
			}

		#no-pin {
			color: #ccc;
			height: 100%;
			width: 100%;
		}
	</style>
	<template>
		<onion-app app-name="GPIO Tool" toolbar-background="#c0392b" background="#f2f2f2">
			<onion-app-body>
				<div class="horizontal center-justified layout center">
					<div class="vertical end-justified layout" id="left-pins">
						<template is="dom-repeat" items="{{leftPins}}">
							<button class$="{{_calculatePinClass(item.gpio)}}" on-tap="_onPin">{{item.label}}</button>
						</template>
					</div>

					<img id="pin-map" src="./omega.png" />

					<div class="vertical end-justified layout" id="right-pins">
						<template is="dom-repeat" items="{{rightPins}}">
							<button class$="{{_calculatePinClass(item.gpio)}}" on-tap="_onPin">{{item.label}}</button>
						</template>
					</div>

					<div id="gpio-control">
						<template is="dom-if" if="{{!pinSelected}}">
							<div id="no-pin" class="horizontal center-justified layout center">Please select a GPIO Pin</div>
						</template>
						<template is="dom-if" if="{{pinSelected}}">
							<div>
								<h5 id="gpio-pin-number">GPIO <span>{{currentPin}}</span></h5>

								<div class="form-group row">
									<label for="direction" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Direction</label>
									<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
										<select id="direction" class="c-select" on-change="_directionChanged" value="{{directionBuffer::input}}">
											<option value="input">Input</option>
											<option value="output">Output</option>
										</select>
									</div>
								</div>
								<div class="form-group row">
									<label for="value" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Value</label>
									<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
										<select id="value" class="c-select" value="{{valueBuffer::input}}" disabled="{{_calculateDirection(currentPin, updateDirection)}}">
											<option value="0">0</option>
											<option value="1">1</option>
										</select>
									</div>
								</div>
								<div class="form-group row">
									<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
										<button class="btn btn-success" on-tap="_sync">Sync</button>
									</div>
								</div>
							</div>
						</template>
					</div>
				</div>
			</onion-app-body>
		</onion-app>
	</template>

	<script>
		'use strict';

		(function () {
			var ready = function() {
				this.title = 'GPIO Tool';

				// populate the info for all pins 
				this._syncAll();
            };

			// populate the array with info for all GPIO pins
            var _syncAll = function () {
				// get the ubus service
				onionConsole.getService('onion-ubus-provider', (function (ubus) {
					for (var index in this.gpios) {
						if (this.gpios.hasOwnProperty(index)) {
							ubus.request('gpio', 'status', {
								pin: index
							}, (function (data) {
								if (data.length === 2 && data[0] === 0) {
									this.set('gpios.' + data[1].pin + '.direction', data[1].direction);
									this.set('gpios.' + data[1].pin + '.activelow', data[1].activelow);
									this.set('gpios.' + data[1].pin + '.value', data[1].value);
									// data[1] contains the following:
									// {pin: int, value: int, direction: "input|output", input: true|false, activelow: false|true}
								} else {
									console.log('gpio status error');
								}
							}).bind(this));
						}
					}
				}).bind(this));
			};

			var _calculatePinClass = function (gpio) {
				return 'pin' + (gpio !== false ? ' gpio' : '');
			};

			var _onPin = function (e) {
				var pin = e.model.item.gpio;

				if (pin !== false) {
					this.set('directionBuffer', this.gpios[pin].direction);
					this.set('valueBuffer', this.gpios[pin].value);
					this.set('currentPin', pin);
					this.set('pinSelected', true);
				} else {
					this.set('currentPin', undefined);
					this.set('pinSelected', false);
				}
			};

			var _sync = function () {
				if (this.updateDirection) {
					// Direction has just been updated. Input becomes output, and vise versa
					if (this.directionBuffer === 'input') {
						// OUTPUT -> INPUT
						onionConsole.getService('onion-ubus-provider', (function (ubus) {
							ubus.request('gpio', 'set_direction', {
								pin: this.currentPin, 
								direction: this.directionBuffer
							}, (function (data) {
								if (data.length === 2 && data[0] === 0) {
									this.set('gpios.' + this.currentPin + '.direction', this.directionBuffer);
									this.set('gpios.' + this.currentPin + '.value', this.valueBuffer);
								} else {
									console.log('gpio read error');
								}
							}).bind(this));
						}).bind(this));

					} else if (this.directionBuffer === 'output') {
						// INPUT -> OUTPUT
						this.set('currentPin', this.currentPin);

						onionConsole.getService('onion-ubus-provider', (function (ubus) {
							ubus.request('gpio', 'set_direction', {
								pin: this.currentPin, 
								direction: this.directionBuffer
							}, (function (data) {
								if (data.length === 2 && data[0] === 0) {
									this.set('gpios.' + this.currentPin + '.direction', this.directionBuffer);
								} else {
									console.log('gpio read error');
								}
							}).bind(this));
						}).bind(this));
					}

					this.set('updateDirection', false);
				} else {
					// Direction has not changed
					if (this.directionBuffer === 'input') {
						// Just need to read data
						onionConsole.getService('onion-ubus-provider', (function (ubus) {
							ubus.request('gpio', 'status', {
								pin: this.currentPin
							}, (function (data) {
								if (data.length === 2 && data[0] === 0) {
									this.set('gpios.' + data[1].pin + '.value', data[1].value);
									
									// Update UI
									this.set('directionBuffer', data[1].direction);
									this.set('valueBuffer', data[1].value);
								} else {
									console.log('gpio status error');
								}
							}).bind(this));
						}).bind(this));
					} else if (this.directionBuffer === 'output') {
						// Set the GPIO Pin
						onionConsole.getService('onion-ubus-provider', (function (ubus) {
							ubus.request('gpio', 'set_pin', {
								pin: this.currentPin, 
								value: this.valueBuffer
							}, (function (data) {
								if (data.length === 2 && data[0] === 0) {
									this.set('gpios.' + this.currentPin + '.value', this.valueBuffer);
								}
							}).bind(this));
						}).bind(this));
					}
					
				}
			};

			var _calculateDirection = function (currentPin, updateDirection) {
				return (this.gpios[currentPin].direction === 'input');
			};

			var _directionChanged = function () {
				this.set('updateDirection', true);
			};

			Polymer({
				is: 'onion-gpio',
				ready: ready,
				behaviors: [Onion.AppBehavior],
				_calculatePinClass: _calculatePinClass,
				_onPin: _onPin,
				_sync: _sync,
				_calculateDirection: _calculateDirection,
				_directionChanged: _directionChanged,
				_syncAll: _syncAll,
				properties: {
					directionBuffer: {
						type: String,
						notify: true
					},
					updateDirection: {
						type: Boolean,
						notify: true
					},
					valueBuffer: {
						type: Number,
						notify: true
					},
					currentPin: {
						type: Number,
						notify: true,
						value: undefined
					},
					pinSelected: {
						type: Boolean,
						notify: true,
						value: false
					},
					leftPins: {
						type: Array,
						value: [
							{label: 'GND', gpio: false},
							{label: '2.8V', gpio: false},
							{label: 'GPIO 26', gpio: 26},
							{label: 'GPIO 23', gpio: 23},
							{label: 'GPIO 17', gpio: 17},
							{label: 'GPIO 16', gpio: 16},
							{label: 'GPIO 15', gpio: 15},
							{label: 'GPIO 14', gpio: 14},
							{label: 'GPIO 13', gpio: 13},
							{label: 'GPIO 12', gpio: 12},
							{label: 'GPIO 8', gpio: 8},
							{label: 'GPIO 7', gpio: 7},
							{label: 'GPIO 6', gpio: 6},
							{label: 'GPIO 1', gpio: 1},
							{label: 'GPIO 0', gpio: 0},
							{label: 'RESET', gpio: false}
						]
					},
					rightPins: {
						type: Array,
						value: [
							{label: 'GND', gpio: false},
							{label: '3.3V', gpio: false},
							{label: 'USB D+', gpio: false},
							{label: 'USB D-', gpio: false},
							{label: 'TX', gpio: false},
							{label: 'RX', gpio: false},
							{label: 'FW RST', gpio: false},
							{label: '2.0V', gpio: false},
							{label: 'ETH TX-', gpio: false},
							{label: 'ETH TX+', gpio: false},
							{label: 'ETH RX-', gpio: false},
							{label: 'ETH RX+', gpio: false},
							{label: 'GPIO 18', gpio: 18},
							{label: 'GPIO 19', gpio: 19},
							{label: 'I2C SCL', gpio: false},
							{label: 'I2C SDA', gpio: false}
						]
					},
					gpios:{
						type: Array,
						notify: true,
						value: {
							0: {direction: 'input', value: 0},
							1: {direction: 'input', value: 0},
							6: {direction: 'input', value: 0},
							7: {direction: 'input', value: 0},
							8: {direction: 'input', value: 0},
							12: {direction: 'input', value: 0},
							13: {direction: 'input', value: 0},
							14: {direction: 'input', value: 0},
							15: {direction: 'input', value: 0},
							16: {direction: 'input', value: 0},
							17: {direction: 'input', value: 0},
							18: {direction: 'input', value: 0},
							19: {direction: 'input', value: 0},
							23: {direction: 'input', value: 0},
							26: {direction: 'input', value: 0}
						}
					}
				}
			});
        })();
	</script>
</dom-module>
