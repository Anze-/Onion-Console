<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/elements/onion-app/onion-app.html">

<dom-module id="onion-status">
	<style>
	    :host {
				display: block;
				height: 100%;
				width: 100%;
		}

		onion-app-body > div {
			height: 100%;
			width: 100%;
			overflow: scroll;
			padding: 15px;
			background-color: #f2f2f2;
		}

		.status {
			width: 300px;
			border-color: transparent;
			margin-left: 5px;
			margin-right: 5px;
		}
			.status .card-block {
				background-color: #fff;
			}
				.status .card-block > p:last-child {
					margin-bottom: 0;
				}
				.status .card-block:last-child {
					height: 200px;
					border-bottom-right-radius: .25rem;
					border-bottom-left-radius: .25rem;
				}

			.status > .status-heading {
				color: #fff;
				background-color: #16a085;
				border-top-left-radius: .25rem;
				border-top-right-radius: .25rem;
			}

		h4 {
			margin-bottom: 10px;
		}

		table {
		    width: 100%;
		}
		
		td {
		    width: 33%;
		}
		#statusContainer {
			height: 100%;
			width: 100%;
			padding: 25px;
			padding-top: 50px;
			margin-top: -50px;
			overflow: auto;
		}

		.status-group {
			background-color: #fff;
			margin: 25px auto;
			margin-top: 10px;
			padding: 25px;
			width: 600px;
			border-radius: 5px;
			line-height: 40px;
			border-top: 2px solid #313338;
			border-top-left-radius: 0;
			border-top-right-radius: 0;
		}
		
		.status-group:last-child {
			margin-bottom: 0;
		}

		.status-field {
			border-top: 1px solid #ddd;
		}

		.online {
			background-color: #5db85c;
			border-radius: 5px;
			color: #fff;
			padding: 5px 10px;
			font-weight: 600;
		}

		.offline {
			background-color: #ff0000;
			border-radius: 5px;
			color: #fff;
			padding: 5px 10px;
			font-weight: 600;
			visibility: hidden;

		}
		
		.status-group button {
			font-size: 14px;
			background-color: #637ca5;
			color: #fff;
			border: 1px solid #42536d;
			border-radius: 5px;
			padding: 5px 10px;
			cursor: pointer;
		}
		
		.status-group button:hover, .status-group button:active, .status-group button:focus {
			background-color: #52698f;
		}
	</style>
	<template>
		<onion-app app-name="Status" toolbar-background="#16a085">
			<onion-app-body>
				<div class="layout horizontal center-justified start">
					<div id="cardsContainer" class="horizontal layout wrap">
						<div class="card status">
							<div class="card-block status-heading">
								<h4 class="card-title" id="online">Online</h4>
								<h4 class="card-title" id="offline">Offline</h4>
								<h6 class="card-subtitle text-muted">Device Status</h6>
							</div>
							<div class="card-block">
								<p><strong>Uptime</strong>:&nbsp;<span>{{uptime}}</span></p>
								<p><strong>Memory</strong>:&nbsp;<span>{{memory}}</span></p>
								<p><strong>Load</strong>:&nbsp;<span>{{load}}</span></p>
							</div>
						</div>

						<div class="card status">
							<div class="card-block status-heading">
								<h4 class="card-title">{{ip}}</h4>
								<h6 class="card-subtitle text-muted">Wi-Fi Network</h6>
							</div>
							<div class="card-block">
								<p><strong>Netmask</strong>:&nbsp;<span>{{netmask}}</span></p>
								<p><strong>MAC Address</strong>:&nbsp;<span>{{mac}}</span></p>
							</div>
						</div>

						<div class="card status">
							<div class="card-block status-heading">
								<h4 class="card-title">{{received}}</h4>
								<h6 class="card-subtitle text-muted">Bytes Received</h6>
							</div>
							<div class="card-block">
								<p class="card-text">The is the total number of bytes received by the Omega</p>
							</div>
						</div>

						<div class="card status">
							<div class="card-block status-heading">
								<h4 class="card-title">{{transmitted}}</h4>
								<h6 class="card-subtitle text-muted">Bytes Transmitted</h6>
							</div>
							<div class="card-block">
								<p class="card-text">The is the total number of bytes transmitted by the Omega</p>
							</div>
						</div>
					</div>
				</div>			
			</onion-app-body>
		</onion-app>
	</template>

	<script>
		'use strict';

		(function () {
			var onionStatus = null;
			var refreshRxTxInterval = null;
			var refreshStatusInterval = null;
			var locked = false;

			var ready = function() {
				this.title = 'Device Status';
	            onionStatus = this;
				
				onionConsole.getService('onion-session-provider', function (sessionProvider) {
					onionStatus.sessionProvider = sessionProvider;
				});
				
				if (onionStatus.sessionProvider.isAlive() === true) {
					onionConsole.getService('onion-device-provider', function (deviceProvider) {
						setInterval(function () {
							deviceProvider.getSystem(function (result) {
								console.log(result);
								onionStatus.uptime = new Date(result[1].uptime * 1000).toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, '$1');
								onionStatus.memory = (result[1].memory.total - result[1].memory.free) + ' / ' + result[1].memory.total;
								onionStatus.load = result[1].load[0] + ' ' + result[1].load[1] + ' ' + result[1].load[2];
							});
						}, 1000);

						onionStatus.deviceProvider = deviceProvider;

						//Get MAC Address
						deviceProvider.getMAC(function (result) {
						    onionStatus.mac = result.mac;
						});

						//Get IP Address, NetMask
						deviceProvider.getIP(function (result) {
							if (result[0].available === true) {
								onionStatus.$.online.style.display = 'block';
								onionStatus.$.offline.style.display = 'none';
							} else {
								onionStatus.$.online.style.display = 'none';
								onionStatus.$.offline.style.display = 'block';
							}

							onionStatus.ip = result[1].ip;
							onionStatus.netmask = result[2].netmask;
						});

						//Get received and transmitted bytes
						updateRxTx();
						refreshRxTx(10000);
					});	
                }			
			};

			var attached = function () {
				var setCardsContainerWidth = function () {
					onionStatus.$.cardsContainer.style.width = Math.floor(window.innerWidth / 310) * 310 + 'px';
				};

				window.addEventListener('resize', setCardsContainerWidth, true);
				setCardsContainerWidth();
			};
			
		    var refreshRxTx = function (interval) {
			    refreshRxTxInterval = setInterval(function () {
			    	updateRxTx()
			    }, interval);
			};
			
			var stopRefreshRxTx = function () { 
			    clearInterval(onionStatus.refreshRxTxInterval);
				delete onionStatus.refreshRxTxInterval;
			};
			
			var updateRxTx = function () {
			    if (onionStatus.sessionProvider.isAlive() === true) {
					onionStatus.deviceProvider.getRxTx(function (result) {
						//console.log('rxResult[' + result[0].received + ']');
						//console.log('txResult[' + result[1].transmitted + ']'); 
						onionStatus.received = result[0].received;
						onionStatus.transmitted = result[1].transmitted;							
					});
				} else {
				    stopRefreshRxTx();
				}
			};
			
			/*
			var refreshStatus = function (interval) {
			    refreshStatusInterval = setInterval(function () {
				    updateStatus()
				}, interval);
			};

			var updateStatus = function () {
			  	ipProvider.getIP(function (result) {
					if(result[0].available === true) {
					    onionStatus.$.online.style.visibility = 'visible';
						onionStatus.$.offline.style.visibility = 'hidden';
					} else {
					    onionStatus.$.online.style.visibility = 'hidden';
					    onionStatus.$.offline.style.visibility = 'visible';
				    }
					onionStatus.ip = result[1].ip;
				});
			};
			*/

			Polymer({
				is: 'onion-status',
				ready: ready,
				attached: attached,
				behaviors: [Onion.AppBehavior],
				refreshRxTx: refreshRxTx,
				stopRefreshRxTx: stopRefreshRxTx,
				updateRxTx: updateRxTx,
				//refreshStatus: refreshStatus,
				//updateStatus: updateStatus,
			});
        })();
	</script>
</dom-module>
