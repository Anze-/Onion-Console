<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/views/onion-framework.html">
<link rel="import" href="/lib/juicy-ace-editor/src/juicy-ace-editor.html">
<link rel="import" href="/lib/file-list/file-list.html">

<dom-module id="onion-editor">
	<style>
		:host {
		    display: block;
	  	    height: 100%;
			width: 100%;
			background-color: black;
		}
		#path-container {
		    color: black;
		    background-color:white;
			font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 12px;
			padding: 5px;
            line-height: 20px;
		}
        #file-list-container { 
			width:20%; 
			height: 85%;
			float:left;
            color: black;			
		    background-color: white;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 12px;
			line-height: normal;
			direction: ltr;		
            overflow-x: auto;
            overflow-y: auto;			
		}
		#editor-container {
		    width:80%;
			height: 85%;
			margin-left:20%;
		}
	    #juicy-ace-editor {
	        width: 100%;
	        height: 100%;
	    }
		#toast1 {
		    margin-left:20%;
		}
		.horizontal-section {
			padding: 0 !important;
        }
		paper-item {
			--paper-item: {
			cursor: pointer;
			};
		}
	</style>
	<template>
		<onion-app-frame title="{{title}}">
			<app-tools-left>
				<button on-click="onLeftButton">Open</button>
			</app-tools-left>

			<app-tools-right>
				<button on-click="onRightButton">Save</button>
			</app-tools-right>
			<app-body>	
			    <div id="path-container">{{currentPath}}</div>
				<div id="file-list-container">
				    <file-list id="file-list">No File</file-list>
				</div>
				<div id="editor-container">
				    <juicy-ace-editor 
				        id="juicy-ace-editor"
                        theme="ace/theme/monokai"
					    mode="ace/mode/text" 
					    fontsize="16px">{{currentCode}}</juicy-ace-editor>
					 <paper-toast id="toast1" text="Your draft has been discarded."></paper-toast>
				</div>
			</app-body>
		</onion-app-frame>	
	</template>
	<script>
		'use strict';

		(function () {
			var onionEditor = null;
			var backsplash=null;
			var extSymbol=null;
			var currentFolderFile=null;
			var ready = function() { 
				this.title = "Onion Editor";
				onionEditor = this;
				backsplash="/";
				extSymbol=".";
				currentFolderFile={"folder":backsplash,"file":"","list":null,"fileInEdit":""};

				onionConsole.getService("onion-session-provider", function (sessionProvider) {
					onionEditor.sessionProvider = sessionProvider;
				});

				if(onionEditor.sessionProvider.isAlive()===true)
				{   
					onionConsole.getService('onion-file-provider', function (fileProvider) {
						onionEditor.fileProvider=fileProvider;
						//Get file list
						fileProvider.getFileList(currentFolderFile.folder,function(result) {
							currentFolderFile.list=result.fileList;
				            var file = document.getElementById("file-list");
                            file.setAttribute("files", JSON.stringify(currentFolderFile.list));
                            onionEditor.currentPath=currentFolderFile.folder;							
							file.addEventListener("click", function(evt) {
				                openFolder(evt.target.textContent);
							});
						});
					});
				};		
			};
				
			var onLeftButton = function () {
			    alert('Left button click');
			};

			var onRightButton = function () {
			    saveFile();
			};
			 
			var findTypeById = function (sourceList, name) {
				for (var i = 0; i < sourceList.length; i++) {
					if (sourceList[i].name === name) {
					    return sourceList[i].type;
					}
				}
			}
			 
			var openFolder = function(path) {
                if(onionEditor.sessionProvider.isAlive()===true) {
			        var currentFile="";
				    onionConsole.getService('onion-file-provider', function (fileProvider) {
				 	    onionEditor.fileProvider=fileProvider;
						if(path.match(/\r?\n|\r/g)!==null)
						{
						    console.log("multiple selection, do nothing");
							return;
						}
					    else if(path==="..")	{
						    if(currentFolderFile.folder===backsplash||currentFolderFile.folder.lastIndexOf(backsplash)===0) {
							    path=backsplash;
						    } else {
							    path=currentFolderFile.folder.substring(0,currentFolderFile.folder.lastIndexOf(backsplash));
                            }
					    } else {
				            if(findTypeById(currentFolderFile.list,path)==="directory") {
							    if(currentFolderFile.folder===backsplash) {
								    path=currentFolderFile.folder+path;
							    } else {
								    path=currentFolderFile.folder+backsplash+path;
							    }
						    } else {
							    if(currentFolderFile.folder===backsplash) {
							        currentFile=path;
								} else {
								    currentFile=backsplash+path;
								}
						    }
					    }

					    if(currentFile==="") {
						    currentFolderFile.folder=path;
                            //Get file list					
                            fileProvider.getFileList(currentFolderFile.folder,function(result) {
							    currentFolderFile.list=result.fileList;
							    var file = document.getElementById("file-list");
							    file.setAttribute("files", JSON.stringify(currentFolderFile.list));	
							    //file.sortOn = "name";
							    onionEditor.currentPath=currentFolderFile.folder;	
						    });
					    } else {
					        currentFolderFile.file=currentFile;
						    console.log("It's a file["+currentFolderFile.folder+currentFolderFile.file+"]");
							openFile();
					    }
				    });
				}
			}
			
			var openFile = function()
			{
			    if(onionEditor.sessionProvider.isAlive()===true && currentFolderFile.file!=='') {
                    if(currentFolderFile.fileInEdit!=="" &&				
	                   onionEditor.currentCode!==document.getElementById('juicy-ace-editor').editor.session.getValue())	{
					    if(confirm('Do you want to save the file?')) {
						    saveFile();
						}
				    }    
				    var ext=currentFolderFile.file.substring(currentFolderFile.file.lastIndexOf(extSymbol)+1,currentFolderFile.file.length);
				    document.getElementById('juicy-ace-editor').editor.session.setMode('ace/mode/'+ext);
                    onionConsole.getService('onion-file-provider', function (fileProvider) {
					    onionEditor.fileProvider=fileProvider;
					    //Get file list
					    fileProvider.getFileContent(currentFolderFile.folder+currentFolderFile.file,function(result) {
						    if(result.fileContent!=null) {
						        onionEditor.currentCode=result.fileContent;
								currentFolderFile.fileInEdit=currentFolderFile.folder+currentFolderFile.file;
							} else {    
							    alert('Failed to open \"'+currentFolderFile.folder+currentFolderFile.file+'\"');
							}
					    });
				    });
				}
            }
			
			var saveFile = function()
			{
				if(onionEditor.sessionProvider.isAlive()===true && currentFolderFile.fileInEdit!=='') {	
				    onionConsole.getService('onion-file-provider', function (fileProvider) {
					    onionEditor.fileProvider=fileProvider;
					    //Get file list
						var codeInEdit=document.getElementById('juicy-ace-editor').editor.session.getValue();
					    fileProvider.saveFileContent(currentFolderFile.fileInEdit,codeInEdit,function(result) {
						    if(result.saveResult===true) {
							    onionEditor.currentCode=codeInEdit;
						        alert('\"'+currentFolderFile.fileInEdit+'\" saved successfully');
							} else {    
							    alert('Failed to save \"'+currentFolderFile.fileInEdit+'\"');
							}
					    });
				    });
				}
			}
			
			Polymer({
				is: 'onion-editor',
				ready: ready,
				onLeftButton: onLeftButton,
				onRightButton: onRightButton,
				openFolder: openFolder,
				openFile: openFile,
				saveFile: saveFile,
			});
        })();
	</script>
</dom-module>
