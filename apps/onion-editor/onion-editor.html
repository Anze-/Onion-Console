<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/juicy-ace-editor/src/juicy-ace-editor.html">
<link rel="import" href="/lib/iron-icon/iron-icon.html">
<link rel="import" href="/lib/paper-dialog/paper-dialog.html">
<link rel="import" href="/elements/onion-app/onion-app.html">
<link rel="import" href="/elements/onion-file-list/onion-file-list.html">

<dom-module id="onion-editor">
	<style>
		:host {
		    display: block;
	  	    height: 100%;
			width: 100%;
		}

		onion-app-body > div {
			height: 100%;
			width: 100%;
		}

		#side-bar {
			width: 300px;
			height: 100%;
			overflow: scroll;
		}

		onion-file-list {
			height: 100%;
		}

		#folder-container {
		    color: black;
		    background-color:white;
			font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
            font-size: 12px;
			padding: 5px;
            line-height: 20px;
		}

		#editor-container {
		    width: 100%;
			height: 100%;
		}

	    #fileEditor {
	        width: 100%;
	        height: 100%;
	    }
		#toast1 {
		    margin-left:20%;
		}
		.horizontal-section {
			padding: 0 !important;
        }
		paper-item {
			--paper-item: {
			cursor: pointer;
			};
		}
		paper-dialog.colored {
            border: 2px solid;
            border-color: var(--paper-green-500);
            background-color: var(--paper-light-green-50);
            color: var(--paper-green-500);
        }
        paper-dialog.size-position {
            position: fixed;
            top: 16px;
            right: 16px;
        }
        paper-dialog.size-position {
          width: 300px;
          height: 300px;
        }
	</style>
	<template>
		<onion-app app-name="Editor">
			<onion-app-body>
				<div class="horizontal layout">
					<div id="side-bar">
					    <div id="folder-container">{{currentFolder}}</div>
						<onion-file-list id="fileList">No File</onion-file-list>
					</div>

					<div id="editor-container" class="flex">
					    <juicy-ace-editor id="fileEditor" theme="ace/theme/monokai" mode="ace/mode/text" fontsize="16px">{{currentCode}}</juicy-ace-editor>
					</div>
				</div>

				<div id="dialog-container">			
                    <paper-dialog id="newDialog" modal>
                        <paper-button on-click="newFolderDialog">New Folder</paper-button>
				        <paper-button on-click="newFileDialog">New File</paper-button>
                    </paper-dialog>

					<paper-dialog id="inputDialog" modal>
					    <div>
							<label for="folderFilename" id="labelString"></label><br>
							<input type="text" id="folderFilename">
						</div>
                        <paper-button dialog-dismiss>Cancel</paper-button>
					    <paper-button on-click="createFile" autofocus>OK</paper-button
                    </paper-dialog>       
			    </div>
			</onion-app-body>
		</onion-app>	
	</template>
	<script>
		'use strict';

		(function () {
			var onionEditor = null;
			var folderFileInfo=null;
			var backsplash=null;
			var extSymbol=null;

			var ready = function() {
				onionEditor = this;	
				backsplash='/';
				extSymbol='.';
				folderFileInfo={"folder":backsplash,"file":"","list":null,"fileInEdit":""};
				onionEditor.title = "Onion Editor";
				onionConsole.getService('onion-session-provider', function (sessionProvider) {
					onionEditor.sessionProvider = sessionProvider;
				});

				if(onionEditor.sessionProvider.isAlive()===true) {   
					onionConsole.getService('onion-file-provider', function (fileProvider) {
						onionEditor.fileProvider=fileProvider;
						//Get file list
						fileProvider.getFileList(folderFileInfo.folder, function(result) {
							if(result.fileList!=='') {
							    onionEditor.currentFolder=folderFileInfo.folder
								folderFileInfo.list=result.fileList;
                                onionEditor.$.fileList.setAttribute('files', JSON.stringify(folderFileInfo.list));			
							    onionEditor.$.fileList.addEventListener('click', function(evt) {
									if(typeof evt.target.icon==='undefined') {
				                        openFolder(evt.target.textContent);
									} else {
									    console.log("Click add icon");
										if(evt.target.icon==="add")
									    {
											onionEditor.$.newDialog.open();
										}
										else if(evt.target.icon==="save")
										{
										    saveFile();
										}
									}						
							    });
							};
						});
					});
				};		
			};
			 
			var findTypeById = function (sourceList, name) {
			    var result='';
				for (var i = 0; i < sourceList.length; i++) {
					if (sourceList[i].name === name) {
					    result = sourceList[i].type;
					}
				}
				return result;
			}
			 
			var isFileChanged = function() {
			    var changed=false;
			    if(folderFileInfo.fileInEdit!=="" &&				
	               onionEditor.currentCode!==onionEditor.$.fileEditor.editor.session.getValue()) {
				    changed=true;
				} 
				return changed;
			}
			
			var getFileExtension = function() {
			    var extension='';
			    if(folderFileInfo.file!=='') {
			        extension=folderFileInfo.file.substring(folderFileInfo.file.lastIndexOf(extSymbol)+1,folderFileInfo.file.length);
			    }
				return extension;
			}
			
			var openFolder = function(path) {
                if(onionEditor.sessionProvider.isAlive()===true) {
			        var currentFile="";
					var changed=true;
				    onionConsole.getService('onion-file-provider', function (fileProvider) {
				 	    onionEditor.fileProvider=fileProvider;
						if(path.match(/\r?\n|\r/g)!==null)
						{
						    console.log("multiple selection, do nothing");
							return;
						}
					    else if(path==="..")	{
						    if(folderFileInfo.folder===backsplash||folderFileInfo.folder.lastIndexOf(backsplash)===0) {
							    path=backsplash;
						    } else {
							    path=folderFileInfo.folder.substring(0,folderFileInfo.folder.lastIndexOf(backsplash));
                            }
					    } else {
						    if(path===folderFileInfo.folder) {
				                changed=false;   
							} else if(findTypeById(folderFileInfo.list,path)==="directory") {
							    if(folderFileInfo.folder===backsplash) {
								    path=folderFileInfo.folder+path;
							    } else {
								    path=folderFileInfo.folder+backsplash+path;
							    }
						    } else {
							    if(folderFileInfo.folder===backsplash) {
							        currentFile=path;
								} else {
								    currentFile=backsplash+path;
								}
						    }
					    }

					    if(changed==false||currentFile==="") {
						    folderFileInfo.folder=path;
                            //Get file list					
                            fileProvider.getFileList(folderFileInfo.folder,function(result) {
							    onionEditor.currentFolder=folderFileInfo.folder;	
							    folderFileInfo.list=result.fileList;
							    onionEditor.$.fileList.setAttribute("files", JSON.stringify(folderFileInfo.list));	 
						    });
					    } else {
					        folderFileInfo.file=currentFile;
						    console.log("It's a file["+folderFileInfo.folder+folderFileInfo.file+"]");
							openFile();
					    }
				    });
				}
			}
			
			var openFile = function()
			{
			    if(onionEditor.sessionProvider.isAlive()===true && folderFileInfo.file!=='') {
                    if(isFileChanged())	{
					    if(confirm('Do you want to save the file?')) {
						    saveFile();
						}
				    }    
				    var ext=getFileExtension();
					onionEditor.$.fileEditor.editor.session.setMode('ace/mode/'+ext);
                    onionConsole.getService('onion-file-provider', function (fileProvider) {
					    onionEditor.fileProvider=fileProvider;
					    //Get file list
					    fileProvider.getFileContent(folderFileInfo.folder+folderFileInfo.file,function(result) {
						    if(result.fileContent!=null) {
						        onionEditor.currentCode=result.fileContent;
								folderFileInfo.fileInEdit=folderFileInfo.folder+folderFileInfo.file;
							} else {    
							    alert('Failed to open \"'+folderFileInfo.folder+folderFileInfo.file+'\"');
							}
					    });
				    });
				}
            }
			
			var saveFile = function()
			{
				if(onionEditor.sessionProvider.isAlive()===true && folderFileInfo.fileInEdit!=='') {	
				    onionConsole.getService('onion-file-provider', function (fileProvider) {
					    onionEditor.fileProvider=fileProvider;
					    //Get file list
						var codeInEdit=onionEditor.$.fileEditor.editor.session.getValue();
					    fileProvider.saveFileContent(folderFileInfo.fileInEdit,codeInEdit,function(result) {
						    if(result.saveResult===true) {
							    onionEditor.currentCode=codeInEdit;
						        alert('\"'+folderFileInfo.fileInEdit+'\" saved successfully');
							} else {    
							    alert('Failed to save \"'+folderFileInfo.fileInEdit+'\"');
							}
					    });
				    });
				}
			}
			
			var newFolderDialog = function()
			{
                 onionEditor.$.newDialog.close();
				 onionEditor.$.inputDialog.open();
				 onionEditor.$.labelString.innerText="New Folder Name";
				 onionEditor.$.folderFilename.value='';
			}
			
			var newFileDialog = function()
			{
                 onionEditor.$.newDialog.close();
				 onionEditor.$.inputDialog.open();
				 onionEditor.$.labelString.innerText="New File Name";
				 onionEditor.$.folderFilename.value='';
			}
			
			var createFile = function()
			{
				onionEditor.$.inputDialog.close();
			    if(onionEditor.sessionProvider.isAlive()===true ) {
				    onionConsole.getService('onion-file-provider', function (fileProvider) {
					    onionEditor.fileProvider=fileProvider;
						var newFilename=onionEditor.$.folderFilename.value
						if(folderFileInfo.folder===backsplash) {
						    newFilename=folderFileInfo.folder+newFilename;
						} else {
							newFilename=folderFileInfo.folder+backsplash+newFilename;
					    }
						
						if(onionEditor.$.labelString.innerText==='New Folder Name') {
							fileProvider.execCommand('mkdir',[newFilename],function(result) {
								if(result.execResult===true) {
							        openFolder(folderFileInfo.folder);
							    } else {    
							        alert('Failed to create \"'+newFilename+'\"');
							    }
							});
						} else {
						    if(findTypeById(folderFileInfo.list,onionEditor.$.folderFilename.value)==='')
							{
							    fileProvider.execCommand('touch',[newFilename],function(result) {
						            if(result.execResult===true) {
							            openFolder(folderFileInfo.folder);
							        } else {    
							            alert('Failed to create \"'+newFilename+'\"');
							        }	
					            });
							}
							else
							{
							   alert('\"'+newFilename+'\" already exist!');
							}
						}
				    });
				} else {
				    alert('Session time out! Failed to create Folder or File!');
				}
				
			}
			
			Polymer({
				is: 'onion-editor',
				ready: ready,
				behaviors: [Onion.AppBehavior],
				openFolder: openFolder,
				openFile: openFile,
				saveFile: saveFile,
				isFileChanged: isFileChanged,
				findTypeById: findTypeById,
				getFileExtension: getFileExtension,
				createFile: createFile,
				newFolderDialog: newFolderDialog,
				newFileDialog: newFileDialog,
			});
        })();
	</script>
</dom-module>
