<link rel="import" href="/lib/polymer/polymer.html">

<dom-module id="onion-session-provider">
	<script>
		'use strict';

		(function () {
			var loginReturn = null;
			var sessionProvider = null;

			var ready = function () {
				sessionProvider = this;
				onionConsole.getService('onion-ubus-provider', function (ubus) {
					sessionProvider.ubus = ubus;
					sessionProvider.ubus.isAlive = false;
				});
				
				onionConsole.getService("onion-apps-provider", function (appsProvider) {
					sessionProvider.appsProvider = appsProvider;
					//onionLauncher.apps = appsProvider.getApps();
				});

			};

			var login = function (username, password, callback) {
				var params =  {
					username: username,
					password: password
				};
				
				loginReturn = callback || function () {};
				this.ubus.request('session', 'login', params, setToken);
			};

			var setToken = function (result) {
				if(result!==null&&result[0]!==null) {
				    if ('error' in result) {
				        sessionProvider.ubus.isAlive = false;
					    loginReturn({success: false});
					    return;
				    }

				    var returnCode = result[0];
				    if (returnCode === 0) { 
					    var token = result[1].ubus_rpc_session;
	                    console.log('session token: ' + token);

					    sessionProvider.ubus.token = token;
					    sessionProvider.ubus.isAlive = true;
					    startHeartbeat(10000);
					    loginReturn({success: true});

				    } else {
				        console.log('Login failed!');
					    sessionProvider.ubus.isAlive = false;
				        loginReturn({success: false});
				    }
				} else {
			        sessionProvider.ubus.isAlive = false;
					loginReturn({success: false});
					return;
			    }
			};
		 
			var heartbeat = function () {
			    if (isAlive()===true) {
					sessionProvider.ubus.request('session', 'access', {}, setAlive);
				} else {
                    logout();   
				}				
			};  
				  
			var startHeartbeat = function (interval) {
			    sessionProvider.heartbeatInterval = setInterval(function () {  
			    	heartbeat()
			    }, interval);
			};
			
			var stopHeartbeat = function () {
			    clearInterval(sessionProvider.heartbeatInterval);
				delete sessionProvider.heartbeatInterval;
				sessionProvider.ubus.isAlive = false;
                sessionProvider.ubus.token = '00000000000000000000000000000000';
			};

			var setAlive = function (result) {
				if (result !== null && result[0] === 0) {
				    sessionProvider.ubus.isAlive = true;   
                    console.log("Alive");					
				} else {
				    sessionProvider.ubus.isAlive = false;
				    logout();
				}   
		    }; 
			
			var isAlive = function () {
			    return 	sessionProvider.ubus.isAlive;
			};
			
			var logout = function() {
				if(sessionProvider.heartbeatInterval !== null) {
				    console.log('logout');
					stopHeartbeat();	
                    window.onionConsole.launchApp('onion-login');					
			    }
			};
			
			Polymer({
				is: 'onion-session-provider',
				ready: ready,
	            login: login,
				logout: logout,
				setToken: setToken,
				setAlive: setAlive,
				heartbeat: heartbeat,
				startHeartbeat: startHeartbeat,
				stopHeartbeat: stopHeartbeat,
				isAlive: isAlive,
			});
        })();
	</script>
</dom-module>
