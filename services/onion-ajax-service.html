<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-ajax/iron-ajax.html">
<link rel="import" href="/lib/iron-signals/iron-signals.html">

<dom-module id="onion-ajax-service">
    <template>
	    <iron-ajax 
		    id='ajax'
			method='POST'
			content-type='application/json'
			on-response='ajaxResponse'
			handle-as='json'
		></iron-ajax> 
	    <onion-ubuspackages-provider id="onion-ubuspackages-provider"></onion-ubuspackages-provider>
    </template>
    <script> 
		var query = function(operation, params) {
		    this.operation=operation;
			var ubuspackage=document.querySelector('#onion-ubuspackages-provider').getUbuspackage(this.operation);
			//console.log(ubuspackage);
			var url=ubuspackage.url;	
			//console.log(url);
			if(operation=='omega-login')
			{
				var username=params.username;
				//console.log(username);
				var password=params.password;
				//console.log(password);
				var body=ubuspackage.body.replace('{{username}}', username).replace('{{password}}', password); 
				//console.log('omega-login: body['+body+']');				
				this.$.ajax.url=url;
				this.$.ajax.body=body;
				this.$.ajax.generateRequest();
			}
			else if(operation=='omega-status')
			{
				var token=localStorage.getItem('token');
				//console.log('omega-status: token['+token+']');
				var body=ubuspackage.body.replace('{{token}}', token);
				//console.log('omega-status: body['+body+']');
				this.$.ajax.url=url;
				this.$.ajax.body=body;
				this.$.ajax.generateRequest();
			} 
			else if(operation=='omega-heartbeat')
			{
				var token=localStorage.getItem('token');
				//console.log('omega-heart: token['+token+']');
				var body=ubuspackage.body.replace('{{token}}', token);
                //console.log('omega-heart: body['+body+']');
				this.$.ajax.url=url;
				this.$.ajax.body=body;
				this.$.ajax.generateRequest();
			}
			else if(operation=='omega-logout')
			{
				if(typeof(Storage) != 'undefined') {
					localStorage.setItem('token', '');
				}
			}
		};
		
		var ajaxResponse = function(request) 
		{
			console.log('Opeartion['+this.operation+'] ajaxResponse['+request.detail.response+']');
			this.fire('iron-signal', {name: this.operation, data: request.detail.response});
		};
		
		Polymer({ 
			is: 'onion-ajax-service', 
			query: query,
			ajaxResponse: ajaxResponse
		});
    </script>
</dom-module>
