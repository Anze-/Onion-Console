<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-signals/iron-signals.html">
<link rel="import" href="/lib/iron-ajax/iron-ajax.html">

<dom-module id="onion-session-provider">
	<template>
		<iron-ajax id="ajax" url="/ubus" method="POST" content-type="application/json" on-response="ajaxResponse" handle-as="json"></iron-ajax> 
	</template>

	<script>
		var ajaxResponse = function (res) {
			console.log(res);
		};

		var login = function (username, password) {
		    console.log('login');

		    //Remove previous session token
			if (typeof(Storage) !== 'undefined') {
				localStorage.removeItem('token');
				localStorage.removeItem('alive');
			}
			
			var body = {
				jsonrpc: '2.0',
				id: 1,
				method: 'call',
				params: [
					'00000000000000000000000000000000',
					'session',
					'login',
					{
						username: username,
						password: password
					}
				]
			};
			
			this.$.ajax.body = JSON.stringify(body);
			this.$.ajax.generateRequest();
		};

		var setToken = function (e, detail, sender) {
			if (detail.result[0] === 0) { 
			    console.log('ajaxResponse[' + detail.result[1] + ']');
                console.log('setToken[' + detail.result[1].ubus_rpc_session + ']');
				if (typeof(Storage) !== 'undefined') {
					localStorage.setItem('token', detail.result[1].ubus_rpc_session);
					localStorage.setItem('alive', true);
				    startHeartbeat(10000);
				}
				this.fire("launchApp", {appId: "onion-launcher"})
			} else {
			    document.querySelector('#msg').innerHTML = 'Login failed!';
			    console.log('Login failed!');
			}
		};
	
		var heartbeat = function () {
		    if (isAlive) {
		        document.querySelector('#onion-ajax-service').query('omega-heartbeat', {});
			}
		}; 
			 
		var startHeartbeat = function (interval) {
		    this.heartbeatInterval = setInterval(function () {
		    	heartbeat()
		    }, interval);
		};
		
		var stopHeartbeat = function () {
		    clearInterval(this.heartbeatInterval);
			delete this.heartbeatInterval;
		};

		var setAlive = function (e, detail, sender) {
		    var alive = false;	
			if (detail !== null && detail.result !== null && detail.result[0] === 0) {
			    alive = true;    
			}
			
			if (typeof(Storage) !== 'undefined') {
				localStorage.setItem('alive', alive);
			}

			if (alive === false) {
			    logout();
				//launch onion-login
			}
	    };
		
		var isAlive = function () {
		    return 	localStorage.getItem('allive');
		};
		
		var logout = function() {
			if(this.heartbeatInterval !== null) {
			    console.log('logout');
				stopHeartbeat();			
				if(typeof(Storage) !== 'undefined') {
					localStorage.removeItem('token');
					localStorage.removeItem('alive');
					//launch onion-login
				}
		    }
		};
		
		Polymer({
			is: 'onion-login-provider',
            login: login,
			logout: logout,
			setToken: setToken,
			setAlive: setAlive
		});
	</script>
</dom-module>
