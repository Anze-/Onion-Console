<link rel="import" href="/lib/polymer/polymer.html">
<link rel="import" href="/lib/iron-overlay-behavior/iron-overlay-behavior.html">

<script>
	'use strict';

	window.BootstrapBehaviors = window.BootstrapBehaviors || {};

	var _ensureSetup = function () {
		if (this._overlaySetup) {
			return;
		}
		this._overlaySetup = true;
    };

	var _openedChanged = function () {
		if (this.opened) {
			this.removeAttribute('aria-hidden');
		} else {
			this.setAttribute('aria-hidden', 'true');
		}

		// wait to call after ready only if we're initially open
		if (!this._overlaySetup) {
			this._callOpenedWhenReady = this.opened;
			return;
		}

		if (this._openChangedAsync) {
			this.cancelAsync(this._openChangedAsync);
		}

		this._toggleListeners();
		
		if (this.opened) {
			this._prepareRenderOpened();
		}

		// async here to allow overlay layer to become visible.
		this._openChangedAsync = this.async(function () {
			// force layout to ensure transitions will go
			/** @suppress {suspiciousCode} */ this.offsetWidth;
			if (this.opened) {
				this._renderOpened();
			} else {
				this._renderClosed();
			}
			this._openChangedAsync = null;
		});
	};

	var _finishRenderClosed = function () {
		// hide the overlay and remove the backdrop
		this.resetFit();
		this._completeBackdrop();
		this._manager.removeOverlay(this);
		this._focusNode.blur();
		// focus the next overlay, if there is one
		this._manager.focusOverlay();
		this.fire('iron-overlay-closed', this.closingReason);
		this._squelchNextResize = true;
		this.async(this.notifyResize);
	};

	var _preparePositioning = function () {
		this.style.transition = this.style.webkitTransition = 'none';
		this.style.transform = this.style.webkitTransform = 'none';
	};

	var _finishPositioning = function () {
		this.style.transform = this.style.webkitTransform = '';
		// force layout to avoid application of transform
		/** @suppress {suspiciousCode} */ this.offsetWidth;
		this.style.transition = this.style.webkitTransition = '';
	};

	var OverlayBehavior = {
		_ensureSetup: _ensureSetup,
		_openedChanged: _openedChanged,
		_finishRenderClosed: _finishRenderClosed,
		_preparePositioning: _preparePositioning,
		_finishPositioning: _finishPositioning
	};

	// Define the behavior
	window.BootstrapBehaviors.OverlayBehavior = [Polymer.IronOverlayBehavior, OverlayBehavior];
</script>